<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="naver-site-verification" content="760dcf2c928601f50f3941df3b6b4629fd244c7c" />
    <!-- Google Ads -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2182912223281192"
    crossorigin="anonymous"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-90VXCLXLJT"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-90VXCLXLJT');
    </script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-245679127-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-245679127-1');
    </script>

    

    
    <title>Ecommerce Recommendation System | Jang Minjee</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="Recommendation System,Deep Nueral Networks,Vertex AI" />
    
    <meta name="description" content="개요 kaggle instacart 데이터로 추천 모델링 시스템을 만들기 빅쿼리, Vertex AI를 사용하여 모델을 만들고 예측하기 참고한 유투브의 추천시스템은 평점 feature가 있지만 이 데이터에는 존재 하지 않음. 따라서 재주문 여부와 주문회차를 평점으로 가정하고 모델에 도입함 200만 유저 중에 10000명으로 제한하였고, 모델 평가에 대한 지표">
<meta property="og:type" content="article">
<meta property="og:title" content="Ecommerce Recommendation System">
<meta property="og:url" content="https://jmj3047.github.io/2023/04/03/Ecommerce_Rec/index.html">
<meta property="og:site_name" content="Jang Minjee">
<meta property="og:description" content="개요 kaggle instacart 데이터로 추천 모델링 시스템을 만들기 빅쿼리, Vertex AI를 사용하여 모델을 만들고 예측하기 참고한 유투브의 추천시스템은 평점 feature가 있지만 이 데이터에는 존재 하지 않음. 따라서 재주문 여부와 주문회차를 평점으로 가정하고 모델에 도입함 200만 유저 중에 10000명으로 제한하였고, 모델 평가에 대한 지표">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://jmj3047.github.io/images/Ecommerce_Rec/structure.png">
<meta property="article:published_time" content="2023-04-02T15:00:00.000Z">
<meta property="article:modified_time" content="2023-04-06T09:01:21.752Z">
<meta property="article:author" content="Jang Minjee">
<meta property="article:tag" content="Recommendation System">
<meta property="article:tag" content="Deep Nueral Networks">
<meta property="article:tag" content="Vertex AI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jmj3047.github.io/images/Ecommerce_Rec/structure.png">
    

    

    
        <link rel="icon" href="/images/favicon.png" />
    

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/libs/titillium-web/styles.css">

    
<link rel="stylesheet" href="/libs/source-code-pro/styles.css">


    
<link rel="stylesheet" href="/css/style.css">


    
<script src="/libs/jquery/3.5.0/jquery.min.js"></script>

    
    
        
<link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">

    
    
        
<link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">

    
    
        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=[object Object]"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '[object Object]');
</script>
<!-- End Google Analytics -->

    
    
    


    
<link rel="stylesheet" href="https://cdn.rawgit.com/innks/NanumSquareRound/master/nanumsquareround.css">

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" target="_blank" rel="noopener" href="https://github.com/jmj3047/mj_portfolio">About Me</a>
                                </li>
                            
                                    <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Data-Analysis/">Data Analysis</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Data-Analysis/Basic/">Basic</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Data-Analysis/Model/">Model</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Data-Platform-Base/">Data Platform/Base</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Data-Platform-Base/GCP/">GCP</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Data-Platform-Base/MongoDB/">MongoDB</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Paper/">Paper</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Paper/Computer-Vision/">Computer Vision</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Paper/Generative-Model/">Generative Model</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Paper/Multi-Task-Learning/">Multi-Task Learning</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Paper/NLP/">NLP</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Paper/Recommendation-System/">Recommendation System</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Paper/Speaker-Verification/">Speaker Verification</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Paper/Speech-Emotion-Recognition/">Speech Emotion Recognition</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Paper/Speech-Representations/">Speech Representations</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Python/">Python</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Python/Django/">Django</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Python/HTML/">HTML</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Python/Pyspark/">Pyspark</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Python/Python/">Python</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Setting/">Setting</a></li></ul>
                                
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Data-Platform-Base/">Data Platform/Base</a><i class="icon fa fa-angle-right"></i><a class="page-title-link" href="/categories/Data-Platform-Base/GCP/">GCP</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-Ecommerce_Rec" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        Ecommerce Recommendation System
        </h1>
    

                
            </header>
        
        
            <div class="article-meta">
                
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2023/04/03/Ecommerce_Rec/" class="article-date">
       <time datetime="2023-04-02T15:00:00.000Z" itemprop="datePublished">2023-04-03</time>
    </a>
  </div>


<div class="article-date">
  <i class="fa fa-calendar-plus-o"></i>
  <a href="/2023/04/03/Ecommerce_Rec/" class="article-date">
     <time datetime="2023-04-06T09:01:21.752Z" itemprop="dateModified">2023-04-06</time>
  </a>
</div>


                

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link-link" href="/tags/Deep-Nueral-Networks/" rel="tag">Deep Nueral Networks</a>, <a class="tag-link-link" href="/tags/Recommendation-System/" rel="tag">Recommendation System</a>, <a class="tag-link-link" href="/tags/Vertex-AI/" rel="tag">Vertex AI</a>
    </div>

                

                

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            

            

            

            <h1 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h1><ul>
<li>kaggle instacart 데이터로 추천 모델링 시스템을 만들기</li>
<li>빅쿼리, Vertex AI를 사용하여 모델을 만들고 예측하기</li>
<li><a href="https://jmj3047.github.io/2023/03/31/DNN_Youtube_Rec/">참고한 유투브의 추천시스템</a>은 평점 feature가 있지만 이 데이터에는 존재 하지 않음. 따라서 재주문 여부와 주문회차를 평점으로 가정하고 모델에 도입함</li>
<li>200만 유저 중에 10000명으로 제한하였고, 모델 평가에 대한 지표는 nDCG를 사용함</li>
</ul>
<h1 id="모델에-대한-간략한-설명"><a href="#모델에-대한-간략한-설명" class="headerlink" title="모델에 대한 간략한 설명"></a>모델에 대한 간략한 설명</h1><p><img src="/images/Ecommerce_Rec/structure.png" alt=" "></p>
<h1 id="사용한-데이터셋-및-cpu-x2F-gpu-성능"><a href="#사용한-데이터셋-및-cpu-x2F-gpu-성능" class="headerlink" title="사용한 데이터셋 및 cpu&#x2F;gpu 성능"></a><strong>사용한 데이터셋 및 cpu&#x2F;gpu 성능</strong></h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.kaggle.com/c/instacart-market-basket-analysis/data">Instacart 데이터셋</a></li>
<li>세부 특성 확인 : <a target="_blank" rel="noopener" href="https://gist.github.com/jeremystan/c3b39d947d9b88b3ccff3147dbcf6c6b">Instacart data dictionary</a></li>
<li>version 1: vCPU 4개, 15GB RAM, GPU 없음 → 텐서플로우가 돌아가지 않음<ul>
<li>비용: 월 202 달러, 시간당 0.27 달러</li>
</ul>
</li>
<li>version2: vCPU 8개, 52GB RAM, GPU NVIDIA Tesla P4 1개<ul>
<li>비용: 월 940 달러, 시간당 1.27 달러</li>
</ul>
</li>
</ul>
<h1 id="Data-import-BQ-→-Jupyter"><a href="#Data-import-BQ-→-Jupyter" class="headerlink" title="Data import (BQ → Jupyter)"></a>Data import (BQ → Jupyter)</h1><ul>
<li>이미 빅쿼리에 csv 파일을 적재함</li>
<li>주피터 커널 안에 ‘%%’ 를 사용하면 빅쿼리 문법을 사용할 수 있음</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%%bigquery aisles</span><br><span class="line">SELECT * FROM `your-project-<span class="built_in">id</span>.your-view.aisles`</span><br><span class="line">ORDER BY <span class="number">1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(aisles.isna().<span class="built_in">sum</span>())</span><br><span class="line">aisles</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%%bigquery departments</span><br><span class="line">SELECT * FROM `your-project-<span class="built_in">id</span>.your-view.departments`</span><br><span class="line">ORDER BY <span class="number">1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(departments.isna().<span class="built_in">sum</span>())</span><br><span class="line">departments</span><br></pre></td></tr></table></figure>

<ul>
<li>이런 형식으로 order_product_prior, order_product_train, orders, products 데이터 프레임을 생성</li>
</ul>
<h1 id="데이터-전처리-결측치-처리-및-샘플링"><a href="#데이터-전처리-결측치-처리-및-샘플링" class="headerlink" title="데이터 전처리: 결측치 처리 및 샘플링"></a>데이터 전처리: 결측치 처리 및 샘플링</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 결측치 처리(&#x27;days_since_prior_order&#x27;:첫 구매인경우 nan값이 입력되어 있음 =&gt; 0으로 대체)</span></span><br><span class="line"><span class="comment">#orders[&#x27;days_since_prior_order&#x27;] = orders[&#x27;days_since_prior_order&#x27;].fillna(0)</span></span><br><span class="line">orders = orders.dropna()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(orders.shape)</span><br><span class="line">orders[<span class="string">&#x27;eval_set&#x27;</span>].value_counts()</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%201.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orders[(orders[<span class="string">&#x27;user_id&#x27;</span>]==<span class="number">10</span>)] <span class="comment"># =&gt; 주문데이터 분석: 유저당 prior주문기록, train주문기록이 있는 유저들이 있음.</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%202.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orders[orders[<span class="string">&#x27;user_id&#x27;</span>].isin(orders[<span class="string">&#x27;user_id&#x27;</span>][orders[<span class="string">&#x27;eval_set&#x27;</span>]==<span class="string">&#x27;test&#x27;</span>])] <span class="comment"># test data -&gt; order_product 정보가 없음</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%203.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orders[<span class="string">&#x27;user_id&#x27;</span>].value_counts()</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%204.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">orders_user_id_eval_set = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> orders[<span class="string">&#x27;user_id&#x27;</span>][orders[<span class="string">&#x27;eval_set&#x27;</span>]==<span class="string">&#x27;train&#x27;</span>].unique():</span><br><span class="line">    i = <span class="built_in">int</span>(i)</span><br><span class="line">    orders_user_id_eval_set.append(i)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line">random.seed(<span class="number">2021</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1만명의 유저만 샘플링 (첫시도)</span></span><br><span class="line">user = random.sample(orders_user_id_eval_set, <span class="number">10000</span>)</span><br><span class="line"><span class="comment">#user = orders[&#x27;user_id&#x27;][orders[&#x27;eval_set&#x27;]==&#x27;train&#x27;].unique().tolist() #샘플링 안하고 시도 (실패)</span></span><br><span class="line"><span class="comment"># orders에서 test dataset 관련 기록(prior포함) 제외</span></span><br><span class="line">orders_2 = orders[orders[<span class="string">&#x27;user_id&#x27;</span>].isin(user)]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;유저 인원:&quot;</span>,<span class="built_in">len</span>(user), <span class="string">&quot;// 주문건수 합:&quot;</span>,<span class="built_in">len</span>(orders_2))</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%205.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># order_product_prior에서 test dataset 관련 기록 제외</span></span><br><span class="line">order_product_prior = order_product_prior[order_product_prior[<span class="string">&#x27;order_id&#x27;</span>].isin(orders_2[<span class="string">&#x27;order_id&#x27;</span>])]</span><br></pre></td></tr></table></figure>

<h1 id="데이터-조합"><a href="#데이터-조합" class="headerlink" title="데이터 조합"></a>데이터 조합</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 제품 정보 : product + aisles + department data</span></span><br><span class="line">product_m = products.merge(aisles).merge(departments)</span><br><span class="line">product_m</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%206.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="comment"># product one-hot encoding data </span></span><br><span class="line">product_enc = pd.get_dummies(product_m, columns=[<span class="string">&#x27;aisle&#x27;</span>], prefix=[<span class="literal">None</span>])</span><br><span class="line">product_encㄹ</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%207.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">order_product = pd.concat([order_product_prior,order_product_train]) </span><br><span class="line">order_product</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%208.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 주문 항목 정보 : product_m + order_product</span></span><br><span class="line">order_detail = order_product.merge(product_m,how=<span class="string">&#x27;left&#x27;</span>) <span class="comment">#.sample(n=100000, random_state=2021)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">order_detail<span class="comment">#.sort_values(by=order_detail[&#x27;order_id&#x27;])</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%209.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data = orders_2.merge(order_detail)<span class="comment">#, on =&#x27;order_id&#x27;)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2010.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.isna().<span class="built_in">sum</span>()</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2011.png" alt=" "></p>
<h1 id="데이터-탐색적-분석-EDA"><a href="#데이터-탐색적-분석-EDA" class="headerlink" title="데이터 탐색적 분석(EDA)"></a>데이터 탐색적 분석(EDA)</h1><h2 id="주문-행태-분석"><a href="#주문-행태-분석" class="headerlink" title="주문 행태 분석"></a>주문 행태 분석</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 요일별 주문 현황</span></span><br><span class="line"></span><br><span class="line">data[<span class="string">&#x27;order_dow&#x27;</span>].value_counts()</span><br><span class="line"></span><br><span class="line">data.hist(<span class="string">&#x27;order_dow&#x27;</span>,grid=<span class="literal">False</span>, bins=<span class="number">7</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2012.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 시간대별 주문 현황</span></span><br><span class="line"></span><br><span class="line">data[<span class="string">&#x27;order_hour_of_day&#x27;</span>].value_counts()</span><br><span class="line"></span><br><span class="line">data.hist(<span class="string">&#x27;order_hour_of_day&#x27;</span>,grid=<span class="literal">False</span>, bins=<span class="number">24</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2013.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 주문 횟수 현황 </span></span><br><span class="line">data[<span class="string">&#x27;order_number&#x27;</span>].value_counts()</span><br><span class="line"></span><br><span class="line">data.hist(<span class="string">&#x27;order_number&#x27;</span>,grid=<span class="literal">False</span>, bins=<span class="number">24</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2014.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 재주문 여부 현황 </span></span><br><span class="line">data[<span class="string">&#x27;reordered&#x27;</span>].value_counts()</span><br><span class="line"></span><br><span class="line">data.hist(<span class="string">&#x27;reordered&#x27;</span>,grid=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2015.png" alt=" "></p>
<h1 id="유투브-추천-알고리즘-적용"><a href="#유투브-추천-알고리즘-적용" class="headerlink" title="유투브 추천 알고리즘 적용"></a>유투브 추천 알고리즘 적용</h1><h2 id="데이터-전처리"><a href="#데이터-전처리" class="headerlink" title="데이터 전처리"></a>데이터 전처리</h2><h3 id="데이터-Encoding"><a href="#데이터-Encoding" class="headerlink" title="데이터 Encoding"></a>데이터 Encoding</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">data[<span class="string">&#x27;user_id&#x27;</span>] = data[<span class="string">&#x27;user_id&#x27;</span>].astype(<span class="built_in">int</span>)</span><br><span class="line">data[<span class="string">&#x27;product_id&#x27;</span>] = data[<span class="string">&#x27;product_id&#x27;</span>].astype(<span class="built_in">int</span>)</span><br><span class="line">data[<span class="string">&#x27;order_id&#x27;</span>] = data[<span class="string">&#x27;order_id&#x27;</span>].astype(<span class="built_in">int</span>)</span><br><span class="line">data[<span class="string">&#x27;days_since_prior_order&#x27;</span>] = data[<span class="string">&#x27;days_since_prior_order&#x27;</span>].astype(<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line">data = data.set_index([<span class="string">&#x27;user_id&#x27;</span>]).sort_index()</span><br><span class="line">data = data.reset_index()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 유저 인덱스 인코딩</span></span><br><span class="line">user_ids = data[<span class="string">&quot;user_id&quot;</span>].unique().tolist()</span><br><span class="line">user2user_encoded = &#123;x: i <span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(user_ids)&#125;</span><br><span class="line"><span class="comment">#userencoded2user = &#123;i: x for i, x in enumerate(user_ids)&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 주문 인덱스 인코딩</span></span><br><span class="line">order_ids = data[<span class="string">&quot;order_id&quot;</span>].unique().tolist()</span><br><span class="line">order2order_encoded = &#123;x: i <span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(order_ids)&#125;</span><br><span class="line"><span class="comment">#order_encoded2order = &#123;i: x for i, x in enumerate(order_ids)&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 상품 인덱스 인코딩</span></span><br><span class="line">product_ids = data[<span class="string">&quot;product_id&quot;</span>].unique().tolist()</span><br><span class="line">product2product_encoded = &#123;x: i <span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(product_ids)&#125;</span><br><span class="line"><span class="comment">#product_encoded2product = &#123;i: x for i, x in enumerate(product_ids)&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 상품 이름 인코딩</span></span><br><span class="line">pd_name_ids = data[<span class="string">&quot;product_name&quot;</span>].unique().tolist()</span><br><span class="line">pd_name2pd_name_encoded = &#123;x: i <span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(pd_name_ids)&#125;</span><br><span class="line"><span class="comment">#pd_name_encoded2pd_name = &#123;i: x for i, x in enumerate(pd_name_ids)&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 상품 대분류 인덱스 인코딩</span></span><br><span class="line">department_ids = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data[<span class="string">&quot;department_id&quot;</span>].unique():</span><br><span class="line">    i = <span class="built_in">int</span>(i)</span><br><span class="line">    department_ids.append(i)</span><br><span class="line">department2department_encoded = &#123;x: i <span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(department_ids)&#125;</span><br><span class="line"><span class="comment">#department_encoded2department = &#123;i: x for i, x in enumerate(department_ids)&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 상품 소분류 인덱스 인코딩</span></span><br><span class="line">aisle_ids = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data[<span class="string">&quot;aisle_id&quot;</span>].unique():</span><br><span class="line">    i = <span class="built_in">int</span>(i)</span><br><span class="line">    aisle_ids.append(i)</span><br><span class="line">aisle2aisle_encoded = &#123;x: i <span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(aisle_ids)&#125;</span><br><span class="line"><span class="comment">#aisle_encoded2aisle = &#123;i: x for i, x in enumerate(aisle_ids)&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 상품 대분류명 인덱스 인코딩</span></span><br><span class="line">dept_name_ids = data[<span class="string">&quot;department&quot;</span>].unique().tolist()</span><br><span class="line">dept_name2dept_name_encoded = &#123;x: i <span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(dept_name_ids)&#125;</span><br><span class="line"><span class="comment">#dept_name_encoded2dept_name = &#123;i: x for i, x in enumerate(dept_name_ids)&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 상품 소분류명 인덱스 인코딩</span></span><br><span class="line">aisle_name_ids = data[<span class="string">&quot;aisle&quot;</span>].unique().tolist()</span><br><span class="line">aisle_name2aisle_name_encoded = &#123;x: i <span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(aisle_name_ids)&#125;</span><br><span class="line"><span class="comment">#aisle_name_encoded2aisle_name = &#123;i: x for i, x in enumerate(aisle_name_ids)&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 인코딩으로 바꾸기</span></span><br><span class="line">data[<span class="string">&quot;user&quot;</span>] = data[<span class="string">&quot;user_id&quot;</span>].<span class="built_in">map</span>(user2user_encoded)</span><br><span class="line">data[<span class="string">&quot;product&quot;</span>] = data[<span class="string">&quot;product_id&quot;</span>].<span class="built_in">map</span>(product2product_encoded)</span><br><span class="line">data[<span class="string">&quot;order&quot;</span>] = data[<span class="string">&quot;order_id&quot;</span>].<span class="built_in">map</span>(order2order_encoded)</span><br><span class="line">data[<span class="string">&quot;pd_name&quot;</span>] = data[<span class="string">&quot;product_name&quot;</span>].<span class="built_in">map</span>(pd_name2pd_name_encoded)</span><br><span class="line"></span><br><span class="line"><span class="comment"># data[&quot;department&quot;] = data[&quot;department_id&quot;].map(department2department_encoded)</span></span><br><span class="line"><span class="comment"># data[&quot;aisle&quot;] = data[&quot;aisle&quot;].map(aisle2aisle_encoded)</span></span><br><span class="line"><span class="comment"># data[&quot;dept_name&quot;] = data[&quot;department&quot;].map(dept_name2dept_name_encoded)</span></span><br><span class="line"><span class="comment"># data[&quot;aisle_name&quot;] = data[&quot;aisle&quot;].map(aisle_name2aisle_name_encoded)</span></span><br></pre></td></tr></table></figure>

<h3 id="User-기준으로-데이터-조정-feature-engineering"><a href="#User-기준으로-데이터-조정-feature-engineering" class="headerlink" title="User 기준으로 데이터 조정(feature engineering)"></a>User 기준으로 데이터 조정(feature engineering)</h3><ul>
<li>구매자 기준으로 데이터 프레임 재생성</li>
<li>feature engineering 추가 기능</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">order_hist = data.groupby([<span class="string">&#x27;user&#x27;</span>])[<span class="string">&#x27;order_id&#x27;</span>].unique().apply(<span class="built_in">list</span>).reset_index()</span><br><span class="line">product_hist = data.groupby([<span class="string">&#x27;user&#x27;</span>])[<span class="string">&#x27;product_id&#x27;</span>].apply(<span class="built_in">list</span>).reset_index()</span><br><span class="line">order_dow_hist = data.groupby([<span class="string">&#x27;user&#x27;</span>])[<span class="string">&#x27;order_dow&#x27;</span>].apply(<span class="built_in">list</span>).reset_index() <span class="comment"># unique().적용해보기</span></span><br><span class="line">order_hour_of_day_hist = data.groupby([<span class="string">&#x27;user&#x27;</span>])[<span class="string">&#x27;order_hour_of_day&#x27;</span>].apply(<span class="built_in">list</span>).reset_index()</span><br><span class="line">days_since_prior_order_hist = data.groupby([<span class="string">&#x27;user&#x27;</span>])[<span class="string">&#x27;days_since_prior_order&#x27;</span>].apply(<span class="built_in">list</span>).reset_index()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.groupby([<span class="string">&#x27;user&#x27;</span>])[<span class="string">&#x27;order_dow&#x27;</span>].unique().apply(<span class="built_in">list</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2016.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">order_product_hist = data.groupby([<span class="string">&#x27;order&#x27;</span>])[<span class="string">&#x27;product_id&#x27;</span>].apply(<span class="built_in">list</span>).reset_index()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">order_hist <span class="comment"># 사용자의 주문목록</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2017.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">product_hist <span class="comment"># 사용자가 구매한 상품</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2018.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">order_product_hist</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2019.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">order_dow_hist</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2020.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">order_hour_of_day_hist</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2021.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">days_since_prior_order_hist</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2022.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># User dataset 생성 (학습에 사용할 데이터, prior order:[data[&#x27;eval_set&#x27;]==&#x27;prior&#x27;])</span></span><br><span class="line">user_data = data[[<span class="string">&#x27;user&#x27;</span>,<span class="string">&#x27;user_id&#x27;</span>]].merge(order_hist, how=<span class="string">&#x27;left&#x27;</span>).merge(product_hist, how=<span class="string">&#x27;left&#x27;</span>).merge(order_dow_hist, how=<span class="string">&#x27;left&#x27;</span>).merge(order_hour_of_day_hist, how = <span class="string">&#x27;left&#x27;</span>).merge(days_since_prior_order_hist,how=<span class="string">&#x27;left&#x27;</span>) <span class="comment">#eval_set</span></span><br><span class="line">user_data</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2023.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user_data = user_data.drop_duplicates(<span class="string">&#x27;user&#x27;</span>) <span class="comment"># 중복데이터 삭제</span></span><br><span class="line">user_data.shape</span><br></pre></td></tr></table></figure>

<p><code>(10000, 7)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data_product_prior=data[<span class="string">&#x27;product&#x27;</span>][data[<span class="string">&#x27;eval_set&#x27;</span>]==<span class="string">&#x27;prior&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="predict-label-생성-및-데이터-분할"><a href="#predict-label-생성-및-데이터-분할" class="headerlink" title="predict_label 생성 및 데이터 분할"></a><strong>predict_label 생성 및 데이터 분할</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user_data[<span class="string">&#x27;predict_labels&#x27;</span>] = user_data[<span class="string">&#x27;product_id&#x27;</span>].apply(<span class="keyword">lambda</span> x: <span class="built_in">int</span>(random.uniform(<span class="number">0</span>,data[<span class="string">&#x27;product_id&#x27;</span>].<span class="built_in">max</span>())))</span><br><span class="line"><span class="comment">#user_data[&#x27;predict_labels&#x27;] = user_data[&#x27;product_id&#x27;].apply(lambda x: int(random.uniform(0,data[&#x27;product&#x27;].max())))</span></span><br><span class="line"><span class="comment"># (random.uniform(0,data[&quot;product&quot;][data[&#x27;eval_set&#x27;]==&#x27;prior&#x27;].max())) train 데이터의 product중 하나 (=&gt; 알맞은 데이터가 들어가는지 코드 검증 필요)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user_data</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2024.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">train_data = user_data[(user_data.user&gt;=<span class="number">30</span>) &amp;</span><br><span class="line">                       (user_data.user&lt;=<span class="number">39</span>)]</span><br><span class="line">test_data = user_data[(user_data.user&gt;=<span class="number">40</span>) &amp;</span><br><span class="line">                      (user_data.user&lt;=<span class="number">59</span>)]</span><br></pre></td></tr></table></figure>

<h2 id="후보모델-candidate-generator-model"><a href="#후보모델-candidate-generator-model" class="headerlink" title="후보모델(candidate generator model)"></a>후보모델(candidate generator model)</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data[<span class="string">&quot;product_id&quot;</span>].<span class="built_in">max</span>()</span><br></pre></td></tr></table></figure>

<p><code>49688</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data[<span class="string">&quot;product&quot;</span>].<span class="built_in">max</span>()</span><br></pre></td></tr></table></figure>

<p><code>35406</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 하이퍼파라미터 정의</span></span><br><span class="line"></span><br><span class="line">EMBEDDING_DIMS = <span class="number">16</span></span><br><span class="line">DENSE_UNITS = <span class="number">64</span></span><br><span class="line">DROPOUT_PCT = <span class="number">0.1</span></span><br><span class="line">ALPHA = <span class="number">0.1</span></span><br><span class="line">NUM_CLASSES = data[<span class="string">&quot;product_id&quot;</span>].<span class="built_in">max</span>() + <span class="number">2</span> </span><br><span class="line">LEARNING_RATE = <span class="number">0.1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.environ[<span class="string">&#x27;TF_CPP_MIN_LOG_LEVEL&#x27;</span>] = <span class="string">&#x27;2&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># custom layers</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MaskedEmbeddingsAggregatorLayer</span>(tf.keras.layers.Layer):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, agg_mode=<span class="string">&#x27;sum&#x27;</span>, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(MaskedEmbeddingsAggregatorLayer, self).__init__(**kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> agg_mode <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">&#x27;sum&#x27;</span>, <span class="string">&#x27;mean&#x27;</span>]:</span><br><span class="line">            <span class="keyword">raise</span> NotImplementedError(<span class="string">&#x27;mode &#123;&#125; not implemented!&#x27;</span>.<span class="built_in">format</span>(agg_mode))</span><br><span class="line">        self.agg_mode = agg_mode</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @tf.function</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">call</span>(<span class="params">self, inputs, mask=<span class="literal">None</span></span>):</span><br><span class="line">        masked_embeddings = tf.ragged.boolean_mask(inputs, mask)</span><br><span class="line">        <span class="keyword">if</span> self.agg_mode == <span class="string">&#x27;sum&#x27;</span>:</span><br><span class="line">            aggregated =  tf.reduce_sum(masked_embeddings, axis=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">elif</span> self.agg_mode == <span class="string">&#x27;mean&#x27;</span>:</span><br><span class="line">            aggregated = tf.reduce_mean(masked_embeddings, axis=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> aggregated</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_config</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># this is used when loading a saved model that uses a custom layer</span></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;agg_mode&#x27;</span>: self.agg_mode&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">L2NormLayer</span>(tf.keras.layers.Layer):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(L2NormLayer, self).__init__(**kwargs)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @tf.function</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">call</span>(<span class="params">self, inputs, mask=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> mask <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            inputs = tf.ragged.boolean_mask(inputs, mask).to_tensor()</span><br><span class="line">        <span class="keyword">return</span> tf.math.l2_normalize(inputs, axis=-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compute_mask</span>(<span class="params">self, inputs, mask</span>):</span><br><span class="line">        <span class="keyword">return</span> mask</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># modeling</span></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">input_user = tf.keras.Input(shape=(<span class="literal">None</span>, ), name=<span class="string">&#x27;user&#x27;</span>) </span><br><span class="line">input_product_hist = tf.keras.layers.Input(shape=(<span class="literal">None</span>,), name=<span class="string">&#x27;product_hist&#x27;</span>)</span><br><span class="line">input_order_dow_hist = tf.keras.layers.Input(shape=(<span class="literal">None</span>,), name=<span class="string">&#x27;order_dow_hist&#x27;</span>)</span><br><span class="line">input_order_hour_of_day_hist = tf.keras.Input(shape=(<span class="literal">None</span>, ), name=<span class="string">&#x27;order_hour_of_day_hist&#x27;</span>)</span><br><span class="line">input_days_since_prior_order_hist = tf.keras.Input(shape=(<span class="literal">None</span>, ), name=<span class="string">&#x27;days_since_prior_order_hist&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># layer 구성</span></span><br><span class="line">features_embedding_layer = tf.keras.layers.Embedding(input_dim=NUM_CLASSES, output_dim=EMBEDDING_DIMS, </span><br><span class="line">                                            mask_zero=<span class="literal">True</span>, trainable=<span class="literal">True</span>, name=<span class="string">&#x27;features_embeddings&#x27;</span>)</span><br><span class="line">labels_embedding_layer = tf.keras.layers.Embedding(input_dim=NUM_CLASSES, output_dim=EMBEDDING_DIMS, </span><br><span class="line">                                            mask_zero=<span class="literal">True</span>, trainable=<span class="literal">True</span>, name=<span class="string">&#x27;labels_embeddings&#x27;</span>)</span><br><span class="line"></span><br><span class="line">avg_embeddings = MaskedEmbeddingsAggregatorLayer(agg_mode=<span class="string">&#x27;mean&#x27;</span>, name=<span class="string">&#x27;aggregate_embeddings&#x27;</span>)</span><br><span class="line"></span><br><span class="line">dense_1 = tf.keras.layers.Dense(units=DENSE_UNITS, name=<span class="string">&#x27;dense_1&#x27;</span>)</span><br><span class="line">dense_2 = tf.keras.layers.Dense(units=DENSE_UNITS, name=<span class="string">&#x27;dense_2&#x27;</span>)</span><br><span class="line">dense_3 = tf.keras.layers.Dense(units=DENSE_UNITS, name=<span class="string">&#x27;dense_3&#x27;</span>)</span><br><span class="line">l2_norm_1 = L2NormLayer(name=<span class="string">&#x27;l2_norm_1&#x27;</span>)</span><br><span class="line">dense_output = tf.keras.layers.Dense(NUM_CLASSES, activation=tf.nn.softmax, name=<span class="string">&#x27;dense_output&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># feature 투입</span></span><br><span class="line">features_embeddings = features_embedding_layer(input_user)</span><br><span class="line">l2_norm_features = l2_norm_1(features_embeddings)</span><br><span class="line">avg_features = avg_embeddings(l2_norm_features)</span><br><span class="line"></span><br><span class="line">labels_product_embeddings = labels_embedding_layer(input_product_hist)</span><br><span class="line">l2_norm_product = l2_norm_1(labels_product_embeddings)</span><br><span class="line">avg_product = avg_embeddings(l2_norm_product)</span><br><span class="line"></span><br><span class="line">labels_order_dow_embeddings = labels_embedding_layer(input_order_dow_hist)</span><br><span class="line">l2_norm_order_dow = l2_norm_1(labels_order_dow_embeddings)</span><br><span class="line">avg_order_dow = avg_embeddings(l2_norm_order_dow)</span><br><span class="line"></span><br><span class="line">labels_order_hour_embeddings = labels_embedding_layer(input_order_hour_of_day_hist)</span><br><span class="line">l2_norm_order_hour = l2_norm_1(labels_order_hour_embeddings)</span><br><span class="line">avg_order_hour = avg_embeddings(l2_norm_order_hour)</span><br><span class="line"></span><br><span class="line">labels_since_prior_embeddings = labels_embedding_layer(input_days_since_prior_order_hist)</span><br><span class="line">l2_norm_since_prior = l2_norm_1(labels_since_prior_embeddings)</span><br><span class="line">avg_since_prior = avg_embeddings(l2_norm_since_prior)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(avg_features)</span><br><span class="line"><span class="built_in">print</span>(avg_order_dow)</span><br><span class="line"><span class="built_in">print</span>(avg_order_hour)</span><br><span class="line"><span class="built_in">print</span>(avg_since_prior)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 임베딩 벡터들 연결</span></span><br><span class="line">concat_inputs = tf.keras.layers.Concatenate(axis=<span class="number">1</span>)([avg_product,</span><br><span class="line">                                                     avg_order_dow, </span><br><span class="line">                                                     avg_order_hour,</span><br><span class="line">                                                     avg_since_prior</span><br><span class="line">                                                     ])</span><br><span class="line"><span class="comment"># Dense Layers</span></span><br><span class="line">dense_1_features = dense_1(concat_inputs)</span><br><span class="line">dense_1_relu = tf.keras.layers.ReLU(name=<span class="string">&#x27;dense_1_relu&#x27;</span>)(dense_1_features)</span><br><span class="line">dense_1_batch_norm = tf.keras.layers.BatchNormalization(name=<span class="string">&#x27;dense_1_batch_norm&#x27;</span>)(dense_1_relu)</span><br><span class="line"></span><br><span class="line">dense_2_features = dense_2(dense_1_relu)</span><br><span class="line">dense_2_relu = tf.keras.layers.ReLU(name=<span class="string">&#x27;dense_2_relu&#x27;</span>)(dense_2_features)</span><br><span class="line">dense_2_batch_norm = tf.keras.layers.BatchNormalization(name=<span class="string">&#x27;dense_2_batch_norm&#x27;</span>)(dense_2_relu)</span><br><span class="line"></span><br><span class="line">dense_3_features = dense_3(dense_2_relu)</span><br><span class="line">dense_3_relu = tf.keras.layers.ReLU(name=<span class="string">&#x27;dense_3_relu&#x27;</span>)(dense_3_features)</span><br><span class="line">dense_3_batch_norm = tf.keras.layers.BatchNormalization(name=<span class="string">&#x27;dense_3_batch_norm&#x27;</span>)(dense_3_relu)</span><br><span class="line"></span><br><span class="line">outputs = dense_output(dense_3_batch_norm)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Optimizer</span></span><br><span class="line">optimiser = tf.keras.optimizers.Adam(learning_rate=LEARNING_RATE)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--- prep model</span></span><br><span class="line">model = tf.keras.models.Model(</span><br><span class="line">    inputs=[input_product_hist,</span><br><span class="line">            input_order_dow_hist,</span><br><span class="line">            input_order_hour_of_day_hist,</span><br><span class="line">            input_days_since_prior_order_hist</span><br><span class="line">            ],</span><br><span class="line">    outputs=[outputs]</span><br><span class="line">)</span><br><span class="line">logdir = os.path.join(<span class="string">&quot;logs&quot;</span>, datetime.datetime.now().strftime(<span class="string">&quot;%Y%m%d-%H%M%S&quot;</span>))</span><br><span class="line">tensorboard_callback = tf.keras.callbacks.TensorBoard(logdir, histogram_freq=<span class="number">1</span>)</span><br><span class="line">model.<span class="built_in">compile</span>(optimizer=optimiser, loss=<span class="string">&#x27;sparse_categorical_crossentropy&#x27;</span>, metrics=[<span class="string">&#x27;acc&#x27;</span>]) </span><br><span class="line"></span><br><span class="line">model.summary()</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2025.png" alt=" "></p>
<p><img src="/images/Ecommerce_Rec/Untitled%2026.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">train_data</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2027.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 학습(training)</span></span><br><span class="line">history = model.fit([tf.keras.preprocessing.sequence.pad_sequences(train_data[<span class="string">&#x27;product_id&#x27;</span>]),</span><br><span class="line">                     tf.keras.preprocessing.sequence.pad_sequences(train_data[<span class="string">&#x27;order_dow&#x27;</span>]),</span><br><span class="line">                     tf.keras.preprocessing.sequence.pad_sequences(train_data[<span class="string">&#x27;order_hour_of_day&#x27;</span>]), <span class="comment">#+ 1e-10, dtype=float</span></span><br><span class="line">                     tf.keras.preprocessing.sequence.pad_sequences(train_data[<span class="string">&#x27;days_since_prior_order&#x27;</span>])</span><br><span class="line">                    ],train_data[<span class="string">&#x27;predict_labels&#x27;</span>].values,</span><br><span class="line">                  <span class="comment">#batch_size=16,</span></span><br><span class="line">                  steps_per_epoch=<span class="number">1</span>, epochs=<span class="number">300</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2028.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 모델 저장</span></span><br><span class="line">model.save(<span class="string">&quot;candidate_generation_v2.h5&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 모델 예측결과 추출</span></span><br><span class="line">pred = model.predict([tf.keras.preprocessing.sequence.pad_sequences(test_data[<span class="string">&#x27;product_id&#x27;</span>]),</span><br><span class="line">           tf.keras.preprocessing.sequence.pad_sequences(test_data[<span class="string">&#x27;order_dow&#x27;</span>]),</span><br><span class="line">           tf.keras.preprocessing.sequence.pad_sequences(test_data[<span class="string">&#x27;order_hour_of_day&#x27;</span>]), <span class="comment">#+ 1e-10, dtype=float</span></span><br><span class="line">           tf.keras.preprocessing.sequence.pad_sequences(test_data[<span class="string">&#x27;days_since_prior_order&#x27;</span>])</span><br><span class="line">           ])</span><br><span class="line"></span><br><span class="line">pred</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2029.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># candidate generation: </span></span><br><span class="line"><span class="comment">###### 각 user당 top-7개의 추천 후보 데이터(predict_label)를 뽑아낸다.</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">N = <span class="number">7</span></span><br><span class="line">k = np.sort((-pred).argsort()[:,:N])</span><br><span class="line"><span class="built_in">print</span>(k)</span><br><span class="line">k = k.flatten()</span><br><span class="line">k[k&gt;data[<span class="string">&quot;product&quot;</span>].<span class="built_in">max</span>()]=<span class="number">0</span></span><br><span class="line">k = np.unique(k)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2030.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2031.png" alt=" "></p>
<h2 id="순위-모델-1-2안-ranking-model-1-2"><a href="#순위-모델-1-2안-ranking-model-1-2" class="headerlink" title="순위 모델 1,2안(ranking model 1,2)"></a>순위 모델 1,2안(ranking model 1,2)</h2><h3 id="1안-재주문여부-reordered-1-like-0-dislike"><a href="#1안-재주문여부-reordered-1-like-0-dislike" class="headerlink" title="1안)재주문여부(reordered), 1:like, 0:dislike"></a>1안)재주문여부(reordered), 1:like, 0:dislike</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># load candidate_generation </span></span><br><span class="line">model = tf.keras.models.load_model(</span><br><span class="line">    <span class="string">&#x27;candidate_generation_v2.h5&#x27;</span>,</span><br><span class="line">    custom_objects=&#123;</span><br><span class="line">        <span class="string">&#x27;L2NormLayer&#x27;</span>:L2NormLayer,</span><br><span class="line">        <span class="string">&#x27;MaskedEmbeddingsAggregatorLayer&#x27;</span>:MaskedEmbeddingsAggregatorLayer</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 아이템의 속성(ex.aisle)을 불러오는 함수 </span></span><br><span class="line"></span><br><span class="line">aisle_cols = aisles[<span class="string">&#x27;aisle&#x27;</span>].values.tolist()</span><br><span class="line"><span class="comment"># type(aisle_cols)</span></span><br><span class="line"><span class="built_in">type</span>(aisle_cols)</span><br><span class="line">aisle_cols</span><br><span class="line"></span><br><span class="line">aisles_encoded = &#123;x: i <span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(aisle_cols)&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># movies-&gt; product_enc</span></span><br><span class="line"><span class="comment"># genres-&gt; aisles</span></span><br><span class="line"><span class="comment"># aisles -&gt; [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, ...]</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_aisles</span>(<span class="params">products, aisles</span>):</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">get_all_aisles</span>(<span class="params">ai</span>):</span><br><span class="line">		active = [<span class="built_in">str</span>(aisles_encoded[aisle]) <span class="keyword">for</span> aisle, a <span class="keyword">in</span> <span class="built_in">zip</span>(aisles, ai) <span class="keyword">if</span> a==<span class="number">1</span>]</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(active) == <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;0&#x27;</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;,&#x27;</span>.join((active))</span><br><span class="line">	</span><br><span class="line">	products[<span class="string">&#x27;all_aisles&#x27;</span>] = [</span><br><span class="line">                              get_all_aisles(ai) <span class="keyword">for</span> ai <span class="keyword">in</span> <span class="built_in">zip</span>(*[products[aisle] <span class="keyword">for</span> aisle <span class="keyword">in</span> aisles]) <span class="comment"># 문제없음.</span></span><br><span class="line">                              ]</span><br><span class="line"></span><br><span class="line">get_aisles(product_enc, aisle_cols)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">product_enc.head(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2032.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data[<span class="string">&#x27;reordered&#x27;</span>].value_counts()</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2033.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ratings = data[[<span class="string">&#x27;product_id&#x27;</span>, <span class="string">&#x27;reordered&#x27;</span>]]</span><br><span class="line">ratings</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2034.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># normalize</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">normalize_col</span>(<span class="params">df,col_name</span>):</span><br><span class="line">    df[col_name] = (df[col_name] - df[col_name].<span class="built_in">min</span>()) / (df[col_name].<span class="built_in">max</span>() - df[col_name].<span class="built_in">min</span>())</span><br><span class="line">    <span class="keyword">return</span> df</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-- rating 데이터 형태로 정리하기 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-- 레퍼런스 코드와 대조하여 정리. </span></span><br><span class="line"><span class="comment"># 레퍼런스: https://github.com/HYEZ/Deep-Youtube-Recommendations/blob/master/neural_net.ipynb</span></span><br><span class="line"><span class="comment"># dataframe: movies-&gt;product_enc</span></span><br><span class="line"><span class="comment"># movie_id -&gt; product_id</span></span><br><span class="line"><span class="comment"># title -&gt; product_name -&gt; pd_name</span></span><br><span class="line"><span class="comment"># title2title_encoded -&gt;pd_name2pd_name_encoded</span></span><br><span class="line"><span class="comment"># genre -&gt; aisle</span></span><br><span class="line"></span><br><span class="line">product_data = product_enc.set_index([<span class="string">&#x27;product_id&#x27;</span>]).sort_index()</span><br><span class="line"></span><br><span class="line"><span class="comment"># using candidate result &#x27;k&#x27;</span></span><br><span class="line">product_data = product_data.loc[k+<span class="number">1</span>]</span><br><span class="line">product_data[<span class="string">&quot;pd_name_d&quot;</span>] = product_data[<span class="string">&quot;product_name&quot;</span>].<span class="built_in">map</span>(pd_name2pd_name_encoded)</span><br><span class="line"><span class="built_in">print</span>(product_data.head())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 레퍼런스와 대조하여 feature 정리: </span></span><br><span class="line"> <span class="comment"># rating -&gt; reordered (1: like / 0: dislike)</span></span><br><span class="line"> <span class="comment"># unix_timestamp-&gt; order_hour_of_day / 굳이 필요없으면 사용하지 않기. </span></span><br><span class="line">ratings_cols = [<span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;product_id&#x27;</span>, <span class="string">&#x27;reordered&#x27;</span>, <span class="string">&#x27;order_hour_of_day&#x27;</span>]</span><br><span class="line">ratings = data[[<span class="string">&#x27;product_id&#x27;</span>, <span class="string">&#x27;reordered&#x27;</span>, <span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;order_hour_of_day&#x27;</span> ]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 모델에 사용할 new_data</span></span><br><span class="line">new_data = product_data.merge(ratings, on=<span class="string">&#x27;product_id&#x27;</span>) <span class="comment"># rating 추가</span></span><br><span class="line"><span class="built_in">print</span>(new_data.columns)</span><br><span class="line"></span><br><span class="line">aisle_occurences = new_data[aisle_cols].<span class="built_in">sum</span>().to_dict()</span><br><span class="line">aisles_encoded = &#123;x: i <span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(aisle_cols)&#125;</span><br><span class="line"></span><br><span class="line">get_aisles(product_data, aisle_cols)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2035.png" alt=" "></p>
<p><img src="/images/Ecommerce_Rec/Untitled%2036.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new_data.columns</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2037.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">new_data = new_data[[<span class="string">&#x27;product_id&#x27;</span>, <span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;reordered&#x27;</span>, <span class="string">&#x27;order_hour_of_day&#x27;</span>, <span class="string">&#x27;all_aisles&#x27;</span>, <span class="string">&#x27;pd_name_d&#x27;</span>]]</span><br><span class="line">new_data[<span class="string">&#x27;product_type&#x27;</span>] = np.where(new_data[<span class="string">&#x27;reordered&#x27;</span>] ==<span class="number">1</span>, <span class="string">&#x27;like&#x27;</span>, <span class="string">&#x27;dislike&#x27;</span>) <span class="comment"># 1이면 like</span></span><br><span class="line"></span><br><span class="line">product_list = new_data.groupby([<span class="string">&#x27;user_id&#x27;</span>,<span class="string">&#x27;product_type&#x27;</span>])[<span class="string">&#x27;product_id&#x27;</span>].apply(<span class="built_in">list</span>).reset_index()</span><br><span class="line"></span><br><span class="line">aisle_list = new_data.groupby([<span class="string">&#x27;user_id&#x27;</span>])[<span class="string">&#x27;all_aisles&#x27;</span>].unique().apply(<span class="built_in">list</span>).reset_index()</span><br><span class="line">aisle_list[<span class="string">&#x27;all_aisles&#x27;</span>]=aisle_list[<span class="string">&#x27;all_aisles&#x27;</span>].apply(<span class="keyword">lambda</span> x: <span class="built_in">list</span>(<span class="built_in">set</span>(<span class="string">&#x27;,&#x27;</span>.join(x))) ) <span class="comment"># 중복제거</span></span><br><span class="line">aisle_list[<span class="string">&#x27;all_aisles&#x27;</span>]=aisle_list[<span class="string">&#x27;all_aisles&#x27;</span>].apply(<span class="keyword">lambda</span> x:[ x <span class="keyword">for</span> x <span class="keyword">in</span> x <span class="keyword">if</span> x.isdigit() ])</span><br><span class="line">    </span><br><span class="line"><span class="comment"># normalize</span></span><br><span class="line">new_data = normalize_col(new_data, <span class="string">&#x27;order_hour_of_day&#x27;</span>)</span><br><span class="line">order_hour_of_day_list = new_data.groupby([<span class="string">&#x27;user_id&#x27;</span>])[<span class="string">&#x27;order_hour_of_day&#x27;</span>].unique().apply(<span class="built_in">list</span>).reset_index()</span><br><span class="line"></span><br><span class="line">pd_name_list = new_data.groupby([<span class="string">&#x27;user_id&#x27;</span>])[<span class="string">&#x27;pd_name_d&#x27;</span>].apply(<span class="built_in">list</span>).reset_index()</span><br><span class="line"><span class="built_in">print</span>(product_list)</span><br><span class="line">dataset = product_list.pivot(index=<span class="string">&#x27;user_id&#x27;</span>, columns=<span class="string">&#x27;product_type&#x27;</span>, values=<span class="string">&#x27;product_id&#x27;</span>).reset_index()</span><br><span class="line">dataset.fillna(new_data[<span class="string">&quot;product_id&quot;</span>].<span class="built_in">max</span>()+<span class="number">1</span>, inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">dataset[<span class="string">&#x27;like&#x27;</span>] =dataset[<span class="string">&#x27;like&#x27;</span>].apply(<span class="keyword">lambda</span> x: x <span class="keyword">if</span> <span class="built_in">type</span>(x) <span class="keyword">is</span> <span class="built_in">list</span> <span class="keyword">else</span> [])</span><br><span class="line">dataset[<span class="string">&#x27;dislike&#x27;</span>] =dataset[<span class="string">&#x27;dislike&#x27;</span>].apply(<span class="keyword">lambda</span> x: x <span class="keyword">if</span> <span class="built_in">type</span>(x) <span class="keyword">is</span> <span class="built_in">list</span> <span class="keyword">else</span> [])</span><br><span class="line"></span><br><span class="line">dataset = pd.merge(dataset, pd_name_list, how=<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line">dataset = pd.merge(dataset, aisle_list, how=<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line">dataset = pd.merge(dataset, order_hour_of_day_list, how=<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line"></span><br><span class="line">dataset[<span class="string">&#x27;predict_labels&#x27;</span>] = dataset[<span class="string">&#x27;like&#x27;</span>].apply(<span class="keyword">lambda</span> x: <span class="built_in">int</span>(random.uniform(<span class="number">1</span>,new_data[<span class="string">&quot;product_id&quot;</span>].<span class="built_in">max</span>()))) </span><br><span class="line"></span><br><span class="line">dataset[<span class="string">&#x27;like&#x27;</span>]=dataset[<span class="string">&#x27;like&#x27;</span>].apply(<span class="keyword">lambda</span> x: [new_data[<span class="string">&quot;product_id&quot;</span>].<span class="built_in">max</span>()+<span class="number">1</span>] <span class="keyword">if</span> x == [] <span class="keyword">else</span> x)</span><br><span class="line">dataset[<span class="string">&#x27;dislike&#x27;</span>]=dataset[<span class="string">&#x27;dislike&#x27;</span>].apply(<span class="keyword">lambda</span> x: [new_data[<span class="string">&quot;product_id&quot;</span>].<span class="built_in">max</span>()+<span class="number">1</span>] <span class="keyword">if</span> x == [] <span class="keyword">else</span> x)</span><br><span class="line"><span class="comment"># train_data=dataset[(dataset.user_id &gt;= 1)&amp;</span></span><br><span class="line"><span class="comment">#                                   (dataset.user_id &lt;= 5)]</span></span><br><span class="line"><span class="comment"># test_data=dataset[(dataset.user_id &gt;= 6)&amp;</span></span><br><span class="line"><span class="comment">#                                   (dataset.user_id &lt;= 9)]</span></span><br><span class="line">train_data_r=dataset[(dataset.index &gt;= <span class="number">0</span>)&amp;</span><br><span class="line">                                  (dataset.index &lt;= <span class="number">9</span>)]</span><br><span class="line">test_data_r=dataset[(dataset.index &gt;= <span class="number">20</span>)&amp;</span><br><span class="line">                                  (dataset.index &lt;= <span class="number">24</span>)]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(dataset.index)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2038.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">train_data_r</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2039.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_data_r</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2040.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 하이퍼파라미터 정의</span></span><br><span class="line">EMBEDDING_DIMS = <span class="number">16</span></span><br><span class="line">DENSE_UNITS = <span class="number">64</span></span><br><span class="line">DROPOUT_PCT = <span class="number">0.1</span></span><br><span class="line">ALPHA = <span class="number">0.0</span></span><br><span class="line">NUM_CLASSES=new_data[<span class="string">&quot;product_id&quot;</span>].<span class="built_in">max</span>() + <span class="number">3</span></span><br><span class="line">LEARNING_RATE = <span class="number">0.003</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 모델</span></span><br><span class="line"><span class="comment">#---inputs</span></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">input_name = tf.keras.Input(shape=(<span class="literal">None</span>, ), name=<span class="string">&#x27;product_name&#x27;</span>)</span><br><span class="line">inp_item_liked = tf.keras.layers.Input(shape=(<span class="literal">None</span>,), name=<span class="string">&#x27;like&#x27;</span>)</span><br><span class="line">inp_item_disliked = tf.keras.layers.Input(shape=(<span class="literal">None</span>,), name=<span class="string">&#x27;dislike&#x27;</span>)</span><br><span class="line">input_aisle = tf.keras.Input(shape=(<span class="literal">None</span>, ), name=<span class="string">&#x27;aisle&#x27;</span>)</span><br><span class="line">input_order_hour = tf.keras.Input(shape=(<span class="literal">None</span>, ), name=<span class="string">&#x27;order_hour&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--- layers</span></span><br><span class="line">features_embedding_layer = tf.keras.layers.Embedding(input_dim=NUM_CLASSES, output_dim=EMBEDDING_DIMS, </span><br><span class="line">                                            mask_zero=<span class="literal">True</span>, trainable=<span class="literal">True</span>, name=<span class="string">&#x27;features_embeddings&#x27;</span>)</span><br><span class="line">labels_embedding_layer = tf.keras.layers.Embedding(input_dim=NUM_CLASSES, output_dim=EMBEDDING_DIMS, </span><br><span class="line">                                            mask_zero=<span class="literal">True</span>, trainable=<span class="literal">True</span>, name=<span class="string">&#x27;labels_embeddings&#x27;</span>)</span><br><span class="line"></span><br><span class="line">avg_embeddings = MaskedEmbeddingsAggregatorLayer(agg_mode=<span class="string">&#x27;mean&#x27;</span>, name=<span class="string">&#x27;aggregate_embeddings&#x27;</span>)</span><br><span class="line"></span><br><span class="line">dense_1 = tf.keras.layers.Dense(units=DENSE_UNITS, name=<span class="string">&#x27;dense_1&#x27;</span>)</span><br><span class="line">dense_2 = tf.keras.layers.Dense(units=DENSE_UNITS, name=<span class="string">&#x27;dense_2&#x27;</span>)</span><br><span class="line">dense_3 = tf.keras.layers.Dense(units=DENSE_UNITS, name=<span class="string">&#x27;dense_3&#x27;</span>)</span><br><span class="line">l2_norm_1 = L2NormLayer(name=<span class="string">&#x27;l2_norm_1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">dense_output = tf.keras.layers.Dense(NUM_CLASSES, activation=tf.nn.softmax, name=<span class="string">&#x27;dense_output&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--- features</span></span><br><span class="line">features_embeddings = features_embedding_layer(input_name)</span><br><span class="line">l2_norm_features = l2_norm_1(features_embeddings)</span><br><span class="line">avg_features = avg_embeddings(l2_norm_features)</span><br><span class="line"></span><br><span class="line">labels_liked_embeddings = labels_embedding_layer(inp_item_liked)</span><br><span class="line">l2_norm_liked = l2_norm_1(labels_liked_embeddings)</span><br><span class="line">avg_liked = avg_embeddings(l2_norm_liked)</span><br><span class="line"></span><br><span class="line">labels_disliked_embeddings = labels_embedding_layer(inp_item_disliked)</span><br><span class="line">l2_norm_disliked = l2_norm_1(labels_disliked_embeddings)</span><br><span class="line">avg_disliked = avg_embeddings(l2_norm_disliked)</span><br><span class="line"></span><br><span class="line">labels_aisle_embeddings = labels_embedding_layer(input_aisle)</span><br><span class="line">l2_norm_aisle = l2_norm_1(labels_aisle_embeddings)</span><br><span class="line">avg_aisle = avg_embeddings(l2_norm_aisle)</span><br><span class="line"></span><br><span class="line">labels_order_hour_embeddings = labels_embedding_layer(input_order_hour)</span><br><span class="line">l2_norm_order_hour = l2_norm_1(labels_order_hour_embeddings)</span><br><span class="line">avg_order_hour = avg_embeddings(l2_norm_order_hour)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 임베딩 벡터들 연결</span></span><br><span class="line">concat_inputs = tf.keras.layers.Concatenate(axis=<span class="number">1</span>)([avg_features,</span><br><span class="line">                                                     avg_liked,</span><br><span class="line">                                                     avg_disliked,</span><br><span class="line">                                                     avg_aisle,</span><br><span class="line">                                                     avg_order_hour</span><br><span class="line">                                                     ])</span><br><span class="line"><span class="comment"># Dense Layers</span></span><br><span class="line">dense_1_features = dense_1(concat_inputs)</span><br><span class="line">dense_1_relu = tf.keras.layers.ReLU(name=<span class="string">&#x27;dense_1_relu&#x27;</span>)(dense_1_features)</span><br><span class="line">dense_1_batch_norm = tf.keras.layers.BatchNormalization(name=<span class="string">&#x27;dense_1_batch_norm&#x27;</span>)(dense_1_relu)</span><br><span class="line"></span><br><span class="line">dense_2_features = dense_2(dense_1_relu)</span><br><span class="line">dense_2_relu = tf.keras.layers.ReLU(name=<span class="string">&#x27;dense_2_relu&#x27;</span>)(dense_2_features)</span><br><span class="line"><span class="comment"># dense_2_batch_norm = tf.keras.layers.BatchNormalization(name=&#x27;dense_2_batch_norm&#x27;)(dense_2_relu)</span></span><br><span class="line"></span><br><span class="line">dense_3_features = dense_3(dense_2_relu)</span><br><span class="line">dense_3_relu = tf.keras.layers.ReLU(name=<span class="string">&#x27;dense_3_relu&#x27;</span>)(dense_3_features)</span><br><span class="line">dense_3_batch_norm = tf.keras.layers.BatchNormalization(name=<span class="string">&#x27;dense_3_batch_norm&#x27;</span>)(dense_3_relu)</span><br><span class="line">outputs = dense_output(dense_3_batch_norm)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Optimizer</span></span><br><span class="line">optimiser = tf.keras.optimizers.Adam(learning_rate=LEARNING_RATE)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--- prep model</span></span><br><span class="line">model = tf.keras.models.Model(</span><br><span class="line">    inputs=[input_name, </span><br><span class="line">            inp_item_liked, </span><br><span class="line">            inp_item_disliked,</span><br><span class="line">            input_aisle,</span><br><span class="line">            input_order_hour,</span><br><span class="line">            ],</span><br><span class="line">    outputs=[outputs]</span><br><span class="line">)</span><br><span class="line">logdir = os.path.join(<span class="string">&quot;logs&quot;</span>, datetime.datetime.now().strftime(<span class="string">&quot;%Y%m%d-%H%M%S&quot;</span>))</span><br><span class="line">tensorboard_callback = tf.keras.callbacks.TensorBoard(logdir, histogram_freq=<span class="number">1</span>)</span><br><span class="line">model.<span class="built_in">compile</span>(optimizer=optimiser, loss=<span class="string">&#x27;sparse_categorical_crossentropy&#x27;</span>, metrics=[<span class="string">&#x27;acc&#x27;</span>])</span><br><span class="line"></span><br><span class="line">model.summary()</span><br></pre></td></tr></table></figure>

<p><code>Model: &quot;model_3&quot;</code></p>
<p><img src="/images/Ecommerce_Rec/Untitled%2041.png" alt=" "></p>
<p><img src="/images/Ecommerce_Rec/Untitled%2042.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#학습</span></span><br><span class="line">train_data_r.columns</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2043.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ratings1 = model.fit([tf.keras.preprocessing.sequence.pad_sequences(train_data_r[<span class="string">&#x27;pd_name_d&#x27;</span>])+ <span class="number">1e-10</span>,</span><br><span class="line">           tf.keras.preprocessing.sequence.pad_sequences(train_data_r[<span class="string">&#x27;like&#x27;</span>])+ <span class="number">1e-10</span>,</span><br><span class="line">           tf.keras.preprocessing.sequence.pad_sequences(train_data_r[<span class="string">&#x27;dislike&#x27;</span>])+ <span class="number">1e-10</span>,</span><br><span class="line">            tf.keras.preprocessing.sequence.pad_sequences(train_data_r[<span class="string">&#x27;all_aisles&#x27;</span>])+ <span class="number">1e-10</span>,</span><br><span class="line">            tf.keras.preprocessing.sequence.pad_sequences(train_data_r[<span class="string">&#x27;order_hour_of_day&#x27;</span>], dtype=<span class="built_in">float</span>) + <span class="number">1e-10</span>,</span><br><span class="line">           ],train_data_r[<span class="string">&#x27;predict_labels&#x27;</span>].values,</span><br><span class="line">           steps_per_epoch=<span class="number">1</span>, epochs=<span class="number">300</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2044.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prediction </span></span><br><span class="line">pred_1 = model.predict([tf.keras.preprocessing.sequence.pad_sequences(test_data_r[<span class="string">&#x27;pd_name_d&#x27;</span>])+ <span class="number">1e-10</span>,</span><br><span class="line">           tf.keras.preprocessing.sequence.pad_sequences(test_data_r[<span class="string">&#x27;like&#x27;</span>])+ <span class="number">1e-10</span>,</span><br><span class="line">           tf.keras.preprocessing.sequence.pad_sequences(test_data_r[<span class="string">&#x27;dislike&#x27;</span>])+ <span class="number">1e-10</span>,</span><br><span class="line">            tf.keras.preprocessing.sequence.pad_sequences(test_data_r[<span class="string">&#x27;all_aisles&#x27;</span>])+ <span class="number">1e-10</span>,</span><br><span class="line">            tf.keras.preprocessing.sequence.pad_sequences(test_data_r[<span class="string">&#x27;order_hour_of_day&#x27;</span>], dtype=<span class="built_in">float</span>) + <span class="number">1e-10</span></span><br><span class="line">           ])</span><br><span class="line"></span><br><span class="line">pred_1</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2045.png" alt=" "></p>
<p><strong>ranking 결과</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ranking</span></span><br><span class="line"><span class="comment">###### 각 user당 top-7개의 추천 데이터를 뽑아낸다.</span></span><br><span class="line">N = <span class="number">7</span></span><br><span class="line"><span class="comment"># k = np.sort((-pred_1).argsort()[:,:N]) </span></span><br><span class="line"><span class="comment"># np.argsort(): probability의 마이너스값을 작은 값부터 순서대로 데이터의 인덱스를 반환. ==&gt; 즉, 양의값으로는 큰 값부터 반환한 셈.</span></span><br><span class="line"><span class="comment"># np.sort(): 인덱스 순으로 다시 정렬. 확률이 더 높은 것부터 보고싶으므로 레퍼런스에 있는 코드이지만 사용하지 않음. </span></span><br><span class="line">ranking_1 = (-pred_1).argsort()[:, :N]</span><br><span class="line"></span><br><span class="line">ranking_1[ranking_1&gt;new_data[<span class="string">&#x27;product_id&#x27;</span>].<span class="built_in">max</span>()]=<span class="number">0</span> </span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ranking_1)</span><br><span class="line"></span><br><span class="line">ranking_1_probability = np.sort(pred_1[:, :N])</span><br><span class="line"><span class="built_in">print</span>(ranking_1_probability)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2046.png" alt=" "></p>
<h3 id="2안-order-number-18번째-이상-like-18번째-미만-dislike"><a href="#2안-order-number-18번째-이상-like-18번째-미만-dislike" class="headerlink" title="2안) order_number: 18번째 이상 like, 18번째 미만 dislike"></a>2안) order_number: 18번째 이상 like, 18번째 미만 dislike</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># load candidate_generation </span></span><br><span class="line">model = tf.keras.models.load_model(</span><br><span class="line">    <span class="string">&#x27;candidate_generation_v2.h5&#x27;</span>,</span><br><span class="line">    custom_objects=&#123;</span><br><span class="line">        <span class="string">&#x27;L2NormLayer&#x27;</span>:L2NormLayer,</span><br><span class="line">        <span class="string">&#x27;MaskedEmbeddingsAggregatorLayer&#x27;</span>:MaskedEmbeddingsAggregatorLayer</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 아이템의 다른 속성(ex. aisle)을 불러오는 기능</span></span><br><span class="line"></span><br><span class="line">aisle_cols = aisles[<span class="string">&#x27;aisle&#x27;</span>].values.tolist()</span><br><span class="line"><span class="comment"># type(aisle_cols)</span></span><br><span class="line"><span class="built_in">type</span>(aisle_cols)</span><br><span class="line">aisle_cols</span><br><span class="line"></span><br><span class="line">aisles_encoded = &#123;x: i <span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(aisle_cols)&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># movies-&gt; product_enc</span></span><br><span class="line"><span class="comment"># genres-&gt; aisles</span></span><br><span class="line"><span class="comment"># aisles -&gt; [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, ...]</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_aisles</span>(<span class="params">products, aisles</span>):</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">get_all_aisles</span>(<span class="params">ai</span>):</span><br><span class="line">		active = [<span class="built_in">str</span>(aisles_encoded[aisle]) <span class="keyword">for</span> aisle, a <span class="keyword">in</span> <span class="built_in">zip</span>(aisles, ai) <span class="keyword">if</span> a==<span class="number">1</span>]</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(active) == <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;0&#x27;</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;,&#x27;</span>.join((active))</span><br><span class="line">	</span><br><span class="line">	products[<span class="string">&#x27;all_aisles&#x27;</span>] = [</span><br><span class="line">                              get_all_aisles(ai) <span class="keyword">for</span> ai <span class="keyword">in</span> <span class="built_in">zip</span>(*[products[aisle] <span class="keyword">for</span> aisle <span class="keyword">in</span> aisles]) <span class="comment"># 문제없음.</span></span><br><span class="line">                              ]</span><br><span class="line"></span><br><span class="line">get_aisles(product_enc, aisle_cols)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">product_enc.head(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2047.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.head()</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2048.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data[[<span class="string">&#x27;order_number&#x27;</span>]].value_counts()</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2049.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 주문데이터의 평균 주문회차 </span></span><br><span class="line">data[<span class="string">&#x27;order_number&#x27;</span>].mean()</span><br></pre></td></tr></table></figure>

<p><code>18.063830654172047</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.shape</span><br></pre></td></tr></table></figure>

<p><code>(1570703, 19)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># order_number분포 확인 </span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">data[<span class="string">&#x27;order_number&#x27;</span>].value_counts()</span><br><span class="line"></span><br><span class="line">data.hist(<span class="string">&#x27;order_number&#x27;</span>,grid=<span class="literal">False</span>, bins = <span class="number">30</span>)</span><br><span class="line">plt.minorticks_on()</span><br><span class="line">plt.tick_params(axis=<span class="string">&#x27;both&#x27;</span>, which =<span class="string">&#x27;both&#x27;</span>, direction=<span class="string">&#x27;in&#x27;</span>, pad=<span class="number">8</span>, top=<span class="literal">True</span>, right=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2050.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data[<span class="string">&#x27;order_number&#x27;</span>].<span class="built_in">min</span>(), data[<span class="string">&#x27;order_number&#x27;</span>].<span class="built_in">max</span>(), data[<span class="string">&#x27;order_number&#x27;</span>].mean()</span><br></pre></td></tr></table></figure>

<p><code>(2, 100, 18.063830654172047)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ratings_2 (order_number: 18이상 like / 18미만 dislike)</span></span><br><span class="line"><span class="comment"># 레퍼런스: https://www.delftstack.com/ko/howto/python-pandas/how-to-create-dataframe-column-based-on-given-condition-in-pandas/</span></span><br><span class="line"><span class="comment"># data[&#x27;ratings_2&#x27;] = data[&#x27;order_number&#x27;][(data[&#x27;order_number&#x27;]&gt;=18)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np </span><br><span class="line"></span><br><span class="line">conditionlist = [ data[<span class="string">&#x27;order_number&#x27;</span>].to_numpy() &gt;= <span class="number">18</span>, data[<span class="string">&#x27;order_number&#x27;</span>].to_numpy()&lt;<span class="number">18</span>]</span><br><span class="line"></span><br><span class="line">choicelist = [<span class="number">1</span>, <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">data[<span class="string">&#x27;ratings_2&#x27;</span>] = np.select(conditionlist, choicelist)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(data[<span class="string">&#x27;ratings_2&#x27;</span>].value_counts())</span><br><span class="line"><span class="built_in">print</span>(data.columns)</span><br><span class="line"><span class="comment"># 데이터 data[&#x27;ratings_2&#x27;] = 1,0 값 확인</span></span><br><span class="line"><span class="comment"># data[[&#x27;order_number&#x27;, &#x27;ratings_2&#x27;]][(data[&#x27;order_number&#x27;]&lt;18)].sort_values(by=&#x27;order_number&#x27;, ascending=False)</span></span><br><span class="line">data[[<span class="string">&#x27;order_number&#x27;</span>, <span class="string">&#x27;ratings_2&#x27;</span>]][(data[<span class="string">&#x27;order_number&#x27;</span>]&gt;=<span class="number">18</span>)].sort_values(by=<span class="string">&#x27;order_number&#x27;</span>, ascending=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2051.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># normalize</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">normalize_col</span>(<span class="params">df,col_name</span>):</span><br><span class="line">    df[col_name] = (df[col_name] - df[col_name].<span class="built_in">min</span>()) / (df[col_name].<span class="built_in">max</span>() - df[col_name].<span class="built_in">min</span>())</span><br><span class="line">    <span class="keyword">return</span> df</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-- rating 데이터 형태로 정리하기 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-- 레퍼런스 코드와 대조하여 정리. </span></span><br><span class="line"><span class="comment"># 레퍼런스: https://github.com/HYEZ/Deep-Youtube-Recommendations/blob/master/neural_net.ipynb</span></span><br><span class="line"><span class="comment"># dataframe: movies-&gt;product_enc</span></span><br><span class="line"><span class="comment"># movie_id -&gt; product_id</span></span><br><span class="line"><span class="comment"># title -&gt; product_name -&gt; pd_name</span></span><br><span class="line"><span class="comment"># title2title_encoded -&gt;pd_name2pd_name_encoded</span></span><br><span class="line"><span class="comment"># genre -&gt; aisle</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1안에서 사용한 product_data 그대로 사용. 아래는 에러 발생시 대안 코드. </span></span><br><span class="line"><span class="comment"># product_data_2 = product_enc.set_index([&#x27;product_id&#x27;]).sort_index()</span></span><br><span class="line"><span class="comment"># using candidate result &#x27;k&#x27;</span></span><br><span class="line"><span class="comment"># product_data_2 = product_data_2.loc[k+1]</span></span><br><span class="line"><span class="comment"># product_data_2[&quot;pd_name_d&quot;] = product_data_2[&quot;product_name&quot;].map(pd_name2pd_name_encoded)</span></span><br><span class="line"><span class="comment"># print(product_data.head())</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 레퍼런스와 대조하여 feature 정리: </span></span><br><span class="line"> <span class="comment"># rating -&gt; reordered (1: like / 0: dislike)</span></span><br><span class="line"> <span class="comment"># unix_timestamp-&gt; order_hour_of_day / 굳이 필요없으면 사용하지 않기. </span></span><br><span class="line">ratings_2_cols = [<span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;product_id&#x27;</span>, <span class="string">&#x27;ratings_2&#x27;</span>, <span class="string">&#x27;order_hour_of_day&#x27;</span>]</span><br><span class="line">ratings_2 = data[[<span class="string">&#x27;product_id&#x27;</span>, <span class="string">&#x27;ratings_2&#x27;</span>, <span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;order_hour_of_day&#x27;</span> ]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 모델에 사용할 new_data</span></span><br><span class="line">new_data_2 = product_data.merge(ratings_2, on=<span class="string">&#x27;product_id&#x27;</span>) <span class="comment"># rating 추가</span></span><br><span class="line"><span class="built_in">print</span>(new_data.columns)</span><br><span class="line"></span><br><span class="line">aisle_occurences = new_data_2[aisle_cols].<span class="built_in">sum</span>().to_dict()</span><br><span class="line">aisles_encoded = &#123;x: i <span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(aisle_cols)&#125;</span><br><span class="line"></span><br><span class="line">get_aisles(product_data, aisle_cols)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2052.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(product_data.columns)</span><br><span class="line"><span class="built_in">print</span>(new_data_2.columns)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2053.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">new_data_2 = new_data_2[[<span class="string">&#x27;product_id&#x27;</span>, <span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;ratings_2&#x27;</span>, <span class="string">&#x27;order_hour_of_day&#x27;</span>, <span class="string">&#x27;all_aisles&#x27;</span>, <span class="string">&#x27;pd_name_d&#x27;</span>]]</span><br><span class="line">new_data_2[<span class="string">&#x27;product_type&#x27;</span>] = np.where(new_data_2[<span class="string">&#x27;ratings_2&#x27;</span>] ==<span class="number">1</span>, <span class="string">&#x27;like&#x27;</span>, <span class="string">&#x27;dislike&#x27;</span>) <span class="comment"># 1이면 like</span></span><br><span class="line"></span><br><span class="line">product_list_2 = new_data_2.groupby([<span class="string">&#x27;user_id&#x27;</span>,<span class="string">&#x27;product_type&#x27;</span>])[<span class="string">&#x27;product_id&#x27;</span>].apply(<span class="built_in">list</span>).reset_index()</span><br><span class="line"></span><br><span class="line">aisle_list_2 = new_data_2.groupby([<span class="string">&#x27;user_id&#x27;</span>])[<span class="string">&#x27;all_aisles&#x27;</span>].unique().apply(<span class="built_in">list</span>).reset_index()</span><br><span class="line">aisle_list_2[<span class="string">&#x27;all_aisles&#x27;</span>]=aisle_list_2[<span class="string">&#x27;all_aisles&#x27;</span>].apply(<span class="keyword">lambda</span> x: <span class="built_in">list</span>(<span class="built_in">set</span>(<span class="string">&#x27;,&#x27;</span>.join(x))) ) <span class="comment"># 중복제거</span></span><br><span class="line">aisle_list_2[<span class="string">&#x27;all_aisles&#x27;</span>]=aisle_list_2[<span class="string">&#x27;all_aisles&#x27;</span>].apply(<span class="keyword">lambda</span> x:[ x <span class="keyword">for</span> x <span class="keyword">in</span> x <span class="keyword">if</span> x.isdigit() ])</span><br><span class="line">    </span><br><span class="line"><span class="comment"># normalize</span></span><br><span class="line">new_data_2 = normalize_col(new_data_2, <span class="string">&#x27;order_hour_of_day&#x27;</span>)</span><br><span class="line">order_hour_of_day_list_2 = new_data_2.groupby([<span class="string">&#x27;user_id&#x27;</span>])[<span class="string">&#x27;order_hour_of_day&#x27;</span>].unique().apply(<span class="built_in">list</span>).reset_index()</span><br><span class="line"></span><br><span class="line">pd_name_list_2 = new_data_2.groupby([<span class="string">&#x27;user_id&#x27;</span>])[<span class="string">&#x27;pd_name_d&#x27;</span>].apply(<span class="built_in">list</span>).reset_index()</span><br><span class="line"><span class="built_in">print</span>(product_list_2)</span><br><span class="line">dataset_2 = product_list_2.pivot(index=<span class="string">&#x27;user_id&#x27;</span>, columns=<span class="string">&#x27;product_type&#x27;</span>, values=<span class="string">&#x27;product_id&#x27;</span>).reset_index()</span><br><span class="line">dataset_2.fillna(new_data_2[<span class="string">&quot;product_id&quot;</span>].<span class="built_in">max</span>()+<span class="number">1</span>, inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">dataset_2[<span class="string">&#x27;like&#x27;</span>] =dataset_2[<span class="string">&#x27;like&#x27;</span>].apply(<span class="keyword">lambda</span> x: x <span class="keyword">if</span> <span class="built_in">type</span>(x) <span class="keyword">is</span> <span class="built_in">list</span> <span class="keyword">else</span> [])</span><br><span class="line">dataset_2[<span class="string">&#x27;dislike&#x27;</span>] =dataset_2[<span class="string">&#x27;dislike&#x27;</span>].apply(<span class="keyword">lambda</span> x: x <span class="keyword">if</span> <span class="built_in">type</span>(x) <span class="keyword">is</span> <span class="built_in">list</span> <span class="keyword">else</span> [])</span><br><span class="line"></span><br><span class="line">dataset_2 = pd.merge(dataset_2, pd_name_list_2, how=<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line">dataset_2 = pd.merge(dataset_2, aisle_list_2, how=<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line">dataset_2 = pd.merge(dataset_2, order_hour_of_day_list_2, how=<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line"></span><br><span class="line">dataset_2[<span class="string">&#x27;predict_labels&#x27;</span>] = dataset_2[<span class="string">&#x27;like&#x27;</span>].apply(<span class="keyword">lambda</span> x: <span class="built_in">int</span>(random.uniform(<span class="number">1</span>,new_data_2[<span class="string">&quot;product_id&quot;</span>].<span class="built_in">max</span>()))) </span><br><span class="line"></span><br><span class="line">dataset_2[<span class="string">&#x27;like&#x27;</span>]=dataset_2[<span class="string">&#x27;like&#x27;</span>].apply(<span class="keyword">lambda</span> x: [new_data_2[<span class="string">&quot;product_id&quot;</span>].<span class="built_in">max</span>()+<span class="number">1</span>] <span class="keyword">if</span> x == [] <span class="keyword">else</span> x)</span><br><span class="line">dataset_2[<span class="string">&#x27;dislike&#x27;</span>]=dataset_2[<span class="string">&#x27;dislike&#x27;</span>].apply(<span class="keyword">lambda</span> x: [new_data_2[<span class="string">&quot;product_id&quot;</span>].<span class="built_in">max</span>()+<span class="number">1</span>] <span class="keyword">if</span> x == [] <span class="keyword">else</span> x)</span><br><span class="line"><span class="comment"># train_data=dataset[(dataset.user_id &gt;= 1)&amp;</span></span><br><span class="line"><span class="comment">#                                   (dataset.user_id &lt;= 5)]</span></span><br><span class="line"><span class="comment"># test_data=dataset[(dataset.user_id &gt;= 6)&amp;</span></span><br><span class="line"><span class="comment">#                                   (dataset.user_id &lt;= 9)]</span></span><br><span class="line">train_data_r_2=dataset_2[(dataset_2.index &gt;= <span class="number">0</span>)&amp;</span><br><span class="line">                                  (dataset_2.index &lt;= <span class="number">9</span>)]</span><br><span class="line">test_data_r_2=dataset_2[(dataset_2.index &gt;= <span class="number">20</span>)&amp;</span><br><span class="line">                                  (dataset_2.index &lt;= <span class="number">24</span>)]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(dataset_2.index)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2054.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">train_data_r_2</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2055.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_data_r_2</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2056.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 하이퍼 파라미터 정의</span></span><br><span class="line">EMBEDDING_DIMS = <span class="number">16</span></span><br><span class="line">DENSE_UNITS = <span class="number">64</span></span><br><span class="line">DROPOUT_PCT = <span class="number">0.1</span></span><br><span class="line">ALPHA = <span class="number">0.0</span></span><br><span class="line">NUM_CLASSES=new_data_2[<span class="string">&quot;product_id&quot;</span>].<span class="built_in">max</span>() + <span class="number">3</span></span><br><span class="line">LEARNING_RATE = <span class="number">0.003</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 모델</span></span><br><span class="line"><span class="comment">#---inputs</span></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">input_name = tf.keras.Input(shape=(<span class="literal">None</span>, ), name=<span class="string">&#x27;product_name&#x27;</span>)</span><br><span class="line">inp_item_liked = tf.keras.layers.Input(shape=(<span class="literal">None</span>,), name=<span class="string">&#x27;like&#x27;</span>)</span><br><span class="line">inp_item_disliked = tf.keras.layers.Input(shape=(<span class="literal">None</span>,), name=<span class="string">&#x27;dislike&#x27;</span>)</span><br><span class="line">input_aisle = tf.keras.Input(shape=(<span class="literal">None</span>, ), name=<span class="string">&#x27;aisle&#x27;</span>)</span><br><span class="line">input_order_hour = tf.keras.Input(shape=(<span class="literal">None</span>, ), name=<span class="string">&#x27;order_hour&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--- layers</span></span><br><span class="line">features_embedding_layer = tf.keras.layers.Embedding(input_dim=NUM_CLASSES, output_dim=EMBEDDING_DIMS, </span><br><span class="line">                                            mask_zero=<span class="literal">True</span>, trainable=<span class="literal">True</span>, name=<span class="string">&#x27;features_embeddings&#x27;</span>)</span><br><span class="line">labels_embedding_layer = tf.keras.layers.Embedding(input_dim=NUM_CLASSES, output_dim=EMBEDDING_DIMS, </span><br><span class="line">                                            mask_zero=<span class="literal">True</span>, trainable=<span class="literal">True</span>, name=<span class="string">&#x27;labels_embeddings&#x27;</span>)</span><br><span class="line"></span><br><span class="line">avg_embeddings = MaskedEmbeddingsAggregatorLayer(agg_mode=<span class="string">&#x27;mean&#x27;</span>, name=<span class="string">&#x27;aggregate_embeddings&#x27;</span>)</span><br><span class="line"></span><br><span class="line">dense_1 = tf.keras.layers.Dense(units=DENSE_UNITS, name=<span class="string">&#x27;dense_1&#x27;</span>)</span><br><span class="line">dense_2 = tf.keras.layers.Dense(units=DENSE_UNITS, name=<span class="string">&#x27;dense_2&#x27;</span>)</span><br><span class="line">dense_3 = tf.keras.layers.Dense(units=DENSE_UNITS, name=<span class="string">&#x27;dense_3&#x27;</span>)</span><br><span class="line">l2_norm_1 = L2NormLayer(name=<span class="string">&#x27;l2_norm_1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">dense_output = tf.keras.layers.Dense(NUM_CLASSES, activation=tf.nn.softmax, name=<span class="string">&#x27;dense_output&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--- features</span></span><br><span class="line">features_embeddings = features_embedding_layer(input_name)</span><br><span class="line">l2_norm_features = l2_norm_1(features_embeddings)</span><br><span class="line">avg_features = avg_embeddings(l2_norm_features)</span><br><span class="line"></span><br><span class="line">labels_liked_embeddings = labels_embedding_layer(inp_item_liked)</span><br><span class="line">l2_norm_liked = l2_norm_1(labels_liked_embeddings)</span><br><span class="line">avg_liked = avg_embeddings(l2_norm_liked)</span><br><span class="line"></span><br><span class="line">labels_disliked_embeddings = labels_embedding_layer(inp_item_disliked)</span><br><span class="line">l2_norm_disliked = l2_norm_1(labels_disliked_embeddings)</span><br><span class="line">avg_disliked = avg_embeddings(l2_norm_disliked)</span><br><span class="line"></span><br><span class="line">labels_aisle_embeddings = labels_embedding_layer(input_aisle)</span><br><span class="line">l2_norm_aisle = l2_norm_1(labels_aisle_embeddings)</span><br><span class="line">avg_aisle = avg_embeddings(l2_norm_aisle)</span><br><span class="line"></span><br><span class="line">labels_order_hour_embeddings = labels_embedding_layer(input_order_hour)</span><br><span class="line">l2_norm_order_hour = l2_norm_1(labels_order_hour_embeddings)</span><br><span class="line">avg_order_hour = avg_embeddings(l2_norm_order_hour)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 임베딩 벡터들 연결</span></span><br><span class="line">concat_inputs = tf.keras.layers.Concatenate(axis=<span class="number">1</span>)([avg_features,</span><br><span class="line">                                                     avg_liked,</span><br><span class="line">                                                     avg_disliked,</span><br><span class="line">                                                     avg_aisle,</span><br><span class="line">                                                     avg_order_hour</span><br><span class="line">                                                     ])</span><br><span class="line"><span class="comment"># Dense Layers</span></span><br><span class="line">dense_1_features = dense_1(concat_inputs)</span><br><span class="line">dense_1_relu = tf.keras.layers.ReLU(name=<span class="string">&#x27;dense_1_relu&#x27;</span>)(dense_1_features)</span><br><span class="line">dense_1_batch_norm = tf.keras.layers.BatchNormalization(name=<span class="string">&#x27;dense_1_batch_norm&#x27;</span>)(dense_1_relu)</span><br><span class="line"></span><br><span class="line">dense_2_features = dense_2(dense_1_relu)</span><br><span class="line">dense_2_relu = tf.keras.layers.ReLU(name=<span class="string">&#x27;dense_2_relu&#x27;</span>)(dense_2_features)</span><br><span class="line"><span class="comment"># dense_2_batch_norm = tf.keras.layers.BatchNormalization(name=&#x27;dense_2_batch_norm&#x27;)(dense_2_relu)</span></span><br><span class="line"></span><br><span class="line">dense_3_features = dense_3(dense_2_relu)</span><br><span class="line">dense_3_relu = tf.keras.layers.ReLU(name=<span class="string">&#x27;dense_3_relu&#x27;</span>)(dense_3_features)</span><br><span class="line">dense_3_batch_norm = tf.keras.layers.BatchNormalization(name=<span class="string">&#x27;dense_3_batch_norm&#x27;</span>)(dense_3_relu)</span><br><span class="line">outputs = dense_output(dense_3_batch_norm)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Optimizer</span></span><br><span class="line">optimiser = tf.keras.optimizers.Adam(learning_rate=LEARNING_RATE)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--- prep model</span></span><br><span class="line">model = tf.keras.models.Model(</span><br><span class="line">    inputs=[input_name, </span><br><span class="line">            inp_item_liked, </span><br><span class="line">            inp_item_disliked,</span><br><span class="line">            input_aisle,</span><br><span class="line">            input_order_hour,</span><br><span class="line">            ],</span><br><span class="line">    outputs=[outputs]</span><br><span class="line">)</span><br><span class="line">logdir = os.path.join(<span class="string">&quot;logs&quot;</span>, datetime.datetime.now().strftime(<span class="string">&quot;%Y%m%d-%H%M%S&quot;</span>))</span><br><span class="line">tensorboard_callback = tf.keras.callbacks.TensorBoard(logdir, histogram_freq=<span class="number">1</span>)</span><br><span class="line">model.<span class="built_in">compile</span>(optimizer=optimiser, loss=<span class="string">&#x27;sparse_categorical_crossentropy&#x27;</span>, metrics=[<span class="string">&#x27;acc&#x27;</span>])</span><br><span class="line"></span><br><span class="line">model.summary()</span><br></pre></td></tr></table></figure>

<p><code>Model: &quot;model_4&quot;</code></p>
<p><img src="/images/Ecommerce_Rec/Untitled%2057.png" alt=" "></p>
<p><img src="/images/Ecommerce_Rec/Untitled%2058.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 학습</span></span><br><span class="line">train_data_r_2.columns</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2059.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ranking_2 = model.fit([tf.keras.preprocessing.sequence.pad_sequences(train_data_r_2[<span class="string">&#x27;pd_name_d&#x27;</span>])+ <span class="number">1e-10</span>,</span><br><span class="line">           tf.keras.preprocessing.sequence.pad_sequences(train_data_r_2[<span class="string">&#x27;like&#x27;</span>])+ <span class="number">1e-10</span>,</span><br><span class="line">           tf.keras.preprocessing.sequence.pad_sequences(train_data_r_2[<span class="string">&#x27;dislike&#x27;</span>])+ <span class="number">1e-10</span>,</span><br><span class="line">            tf.keras.preprocessing.sequence.pad_sequences(train_data_r_2[<span class="string">&#x27;all_aisles&#x27;</span>])+ <span class="number">1e-10</span>,</span><br><span class="line">            tf.keras.preprocessing.sequence.pad_sequences(train_data_r_2[<span class="string">&#x27;order_hour_of_day&#x27;</span>], dtype=<span class="built_in">float</span>) + <span class="number">1e-10</span>,</span><br><span class="line">           ],train_data_r_2[<span class="string">&#x27;predict_labels&#x27;</span>].values,</span><br><span class="line">           steps_per_epoch=<span class="number">1</span>, epochs=<span class="number">300</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2060.png" alt=" "></p>
<p><img src="/images/Ecommerce_Rec/Untitled%2061.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prediction </span></span><br><span class="line">pred_2 = model.predict([tf.keras.preprocessing.sequence.pad_sequences(test_data_r_2[<span class="string">&#x27;pd_name_d&#x27;</span>])+ <span class="number">1e-10</span>,</span><br><span class="line">           tf.keras.preprocessing.sequence.pad_sequences(test_data_r_2[<span class="string">&#x27;like&#x27;</span>])+ <span class="number">1e-10</span>,</span><br><span class="line">           tf.keras.preprocessing.sequence.pad_sequences(test_data_r_2[<span class="string">&#x27;dislike&#x27;</span>])+ <span class="number">1e-10</span>,</span><br><span class="line">            tf.keras.preprocessing.sequence.pad_sequences(test_data_r_2[<span class="string">&#x27;all_aisles&#x27;</span>])+ <span class="number">1e-10</span>,</span><br><span class="line">            tf.keras.preprocessing.sequence.pad_sequences(test_data_r_2[<span class="string">&#x27;order_hour_of_day&#x27;</span>], dtype=<span class="built_in">float</span>) + <span class="number">1e-10</span></span><br><span class="line">           ])</span><br><span class="line">pred_2</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2062.png" alt=" "></p>
<p><strong>ranking 결과</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ranking</span></span><br><span class="line"><span class="comment">###### 각 user당 top-7개의 추천 데이터를 뽑아낸다.</span></span><br><span class="line">N = <span class="number">7</span></span><br><span class="line"><span class="comment"># k = np.sort((-pred_1).argsort()[:,:N]) </span></span><br><span class="line"><span class="comment"># np.argsort(): probability의 마이너스값을 작은 값부터 순서대로 데이터의 인덱스를 반환. ==&gt; 즉, 양의값으로는 큰 값부터 반환한 셈.</span></span><br><span class="line"><span class="comment"># np.sort(): 인덱스 순으로 다시 정렬. 확률이 더 높은 것부터 보고싶으므로 레퍼런스에 있는 코드이지만 사용하지 않음. </span></span><br><span class="line">ranking_2 = (-pred_2).argsort()[:, :N]</span><br><span class="line"></span><br><span class="line">ranking_2[ranking_2&gt;new_data_2[<span class="string">&#x27;product_id&#x27;</span>].<span class="built_in">max</span>()]=<span class="number">0</span> </span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ranking_2)</span><br><span class="line"></span><br><span class="line">ranking_2_probability = np.sort(pred_2[:, :N])</span><br><span class="line"><span class="built_in">print</span>(ranking_2_probability)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 추출된 인덱스 값들은 user별 구매목록라벨(여러개 상품들이 있는). 유사도 높은 다른 유저들의 구매목록이 추천된 셈.</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2063.png" alt=" "></p>
<h2 id="순위모델-1-2안-평과-결과-ranking-eval-nDCG-score"><a href="#순위모델-1-2안-평과-결과-ranking-eval-nDCG-score" class="headerlink" title="순위모델 1,2안 평과 결과(ranking-eval(nDCG score))"></a>순위모델 1,2안 평과 결과(ranking-eval(nDCG score))</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1안의 유저별 추천 &#x27;상품묶음&#x27; 라벨들. </span></span><br><span class="line">ranking_1</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2064.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -- 라벨의 like_id값 비교용 </span></span><br><span class="line"><span class="comment"># pd_name_d</span></span><br><span class="line"><span class="comment"># train_data_r[[&#x27;predict_labels&#x27;,&#x27;pd_name_d&#x27;]]</span></span><br><span class="line">train_df1 = train_data_r[[<span class="string">&#x27;like&#x27;</span>, <span class="string">&#x27;predict_labels&#x27;</span>]]</span><br><span class="line">train_df1 = train_df1.rename(columns = &#123;<span class="string">&#x27;like&#x27;</span>:<span class="string">&#x27;like_id&#x27;</span>, <span class="string">&#x27;predict_labels&#x27;</span>: <span class="string">&#x27;label&#x27;</span>&#125;)</span><br><span class="line">train_df1</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2065.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># predict_labels: 유저별 라벨 역할. </span></span><br><span class="line"><span class="comment"># pd_name_d : user A가 구매한 상품명 인덱스 수치 묶음.</span></span><br><span class="line"><span class="comment"># 비슷한 유저의 상품 목록을 추천하는 것으로 생각. </span></span><br><span class="line"></span><br><span class="line">true_df1 = test_data_r[[<span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;like&#x27;</span>, <span class="string">&#x27;predict_labels&#x27;</span>]]</span><br><span class="line"><span class="comment"># pred_data_1</span></span><br><span class="line">true_df1 = true_df1.rename(columns=&#123;<span class="string">&#x27;like&#x27;</span>: <span class="string">&#x27;true_like_id&#x27;</span></span><br><span class="line">                                          ,<span class="string">&#x27;predict_labels&#x27;</span>: <span class="string">&#x27;true_labels&#x27;</span>&#125;)</span><br><span class="line">true_df1 = true_df1[[<span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;true_like_id&#x27;</span>]]</span><br><span class="line">true_df1</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2066.png" alt=" "></p>
<h3 id="rank-1안-최종-ndcg-값-함수-사용"><a href="#rank-1안-최종-ndcg-값-함수-사용" class="headerlink" title="rank_1안 최종 ndcg 값(함수 사용)"></a>rank_1안 최종 ndcg 값(함수 사용)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># user 당 추천목록 데이터 추출하는 기능</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_rec</span>(<span class="params">n , rank, rec_df, train_df</span>):</span><br><span class="line">  <span class="comment"># 전달인자(argument) 설명 :</span></span><br><span class="line">   <span class="comment">## n: 몇번째 유저인지(the order of test-user starting from 0) </span></span><br><span class="line">   <span class="comment">## rank: 랭킹 결과 (ranking result of ranking model (array type))</span></span><br><span class="line">   <span class="comment">## rec_df: 유저당 추천된 라벨과 라벨에 해당하는 상품 아이디 데이터프레임 (recommended label and product_id for each user)</span></span><br><span class="line">   <span class="comment">## train_df: 랭킹 모델학습에 사용된 학습데이터에서 필요한 like, predict_labels만 추출한 데이터프레임(train_data&#x27;s &#x27;like and predict_labels&#x27;features used for ranking_model training)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> label <span class="keyword">in</span> rank[n-<span class="number">1</span>]: <span class="comment"># user2번째(array index=1) DF 만들기.</span></span><br><span class="line">    rec_id = train_df[<span class="string">&#x27;like_id&#x27;</span>][(train_df[<span class="string">&#x27;label&#x27;</span>]==label)].tolist()</span><br><span class="line">    rec_df = rec_df.append(pd.DataFrame([[label, rec_id]], columns=[<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;rec_id&#x27;</span>]), ignore_index=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># rec_id = train_data[&#x27;product_id&#x27;][(train_data[&#x27;label&#x27;]==label)].values</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> rec_df</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user1</span></span><br><span class="line"><span class="comment"># user1_rec_data = pd.DataFrame(columns=[&#x27;label&#x27;, &#x27;rec_id&#x27;, &#x27;T/F&#x27;])</span></span><br><span class="line">user1_rec_data = pd.DataFrame(columns=[<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;rec_id&#x27;</span>])</span><br><span class="line"></span><br><span class="line">rec_df1 = user_rec(<span class="number">1</span>, ranking_1, user1_rec_data, train_df1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;user1_rec_data&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(rec_df1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user2</span></span><br><span class="line"><span class="comment"># user2_rec_data = pd.DataFrame(columns=[&#x27;label&#x27;, &#x27;rec_id&#x27;, &#x27;T/F&#x27;])</span></span><br><span class="line">user2_rec_data = pd.DataFrame(columns=[<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;rec_id&#x27;</span>])</span><br><span class="line"></span><br><span class="line">rec_df2 = user_rec(<span class="number">2</span>, ranking_1, user2_rec_data, train_df1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;user2_rec_data&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(rec_df2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user3</span></span><br><span class="line">user3_rec_data = pd.DataFrame(columns=[<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;rec_id&#x27;</span>])</span><br><span class="line"></span><br><span class="line">rec_df3 = user_rec(<span class="number">3</span>, ranking_1, user3_rec_data, train_df1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;user3_rec_data&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(rec_df3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user4</span></span><br><span class="line">user4_rec_data = pd.DataFrame(columns=[<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;rec_id&#x27;</span>])</span><br><span class="line"></span><br><span class="line">rec_df4 = user_rec(<span class="number">4</span>, ranking_1, user4_rec_data, train_df1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;user4_rec_data&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(rec_df4)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user5</span></span><br><span class="line">user5_rec_data = pd.DataFrame(columns=[<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;rec_id&#x27;</span>])</span><br><span class="line"></span><br><span class="line">rec_df5 = user_rec(<span class="number">5</span>, ranking_1, user5_rec_data, train_df1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;user5_rec_data&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(rec_df5)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2067.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 각 유저별 추천목록의 상품들 중 true-like한 것이 있는지 T/F(trud:1/false:0)으로 데이터프레임에 넣어주는 기능.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">true_like</span>(<span class="params">n, rec_df, true_df</span>):</span><br><span class="line">  <span class="comment"># 전달인자(argument)설명: </span></span><br><span class="line">   <span class="comment">## n: 몇번째 유저인지 (the order of test-user starting from 0)</span></span><br><span class="line">   <span class="comment">## rec_df: 유저당 추천된 라벨과 라벨에 해당하는 상품 아이디 데이터프레임 (recommended label and product_id for each user)</span></span><br><span class="line">   <span class="comment">## true_df: 랭킹모델의 예측에 사용된 test_data중에서 필요한 &#x27;user_id, true_like_id&#x27;특성만 추출한 데이터프레임(test_data&#x27;s &#x27;user_id and true_like_id&#x27;features used for ranking_model predicting)</span></span><br><span class="line">  tf_list = []</span><br><span class="line">  rec_id = rec_df[<span class="string">&#x27;rec_id&#x27;</span>].tolist() </span><br><span class="line">  <span class="comment"># rec_id = rec_df[&#x27;rec_id&#x27;].values </span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># true데이터인 test_data의 형태상, row에 있는 유저 n-1번째 row를 고정해야 함. </span></span><br><span class="line">  true = true_df[<span class="string">&#x27;true_like_id&#x27;</span>].tolist()[n-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> rec <span class="keyword">in</span> rec_id[:][:]:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(rec) == <span class="number">0</span>:</span><br><span class="line">      tf_list.append(<span class="number">0.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">len</span>(rec)&gt;=<span class="number">1</span>:        </span><br><span class="line">      tf = true[<span class="number">0</span>] <span class="keyword">in</span> rec[<span class="number">0</span>]</span><br><span class="line">      <span class="keyword">if</span> tf == <span class="literal">True</span>:</span><br><span class="line">        tf_list.append(<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        tf_list.append(<span class="number">0</span>)</span><br><span class="line">      rec_df[<span class="string">&#x27;T/F&#x27;</span>] = pd.DataFrame(tf_list)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;true_like_id:&quot;</span>, true)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rec_df</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user1의 추천목록에 대한 T/F(true-like or false) 결과 </span></span><br><span class="line">rec_df1 = true_like(<span class="number">1</span>, rec_df1, true_df1)</span><br><span class="line"><span class="built_in">print</span>(rec_df1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user2의 추천목록에 대한 T/F(true-like or false) 결과 </span></span><br><span class="line">rec_df2 = true_like(<span class="number">2</span>, rec_df2, true_df1)</span><br><span class="line"><span class="built_in">print</span>(rec_df2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user3의 추천목록에 대한 T/F(true-like or false) 결과 </span></span><br><span class="line">rec_df3 = true_like(<span class="number">3</span>, rec_df3, true_df1)</span><br><span class="line"><span class="built_in">print</span>(rec_df3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user4의 추천목록에 대한 T/F(true-like or false) 결과 </span></span><br><span class="line">rec_df4 = true_like(<span class="number">4</span>, rec_df4, true_df1)</span><br><span class="line"><span class="built_in">print</span>(rec_df4)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user5의 추천목록에 대한 T/F(true-like or false) 결과 </span></span><br><span class="line">rec_df5 = true_like(<span class="number">5</span>, rec_df5, true_df1)</span><br><span class="line"><span class="built_in">print</span>(rec_df5)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2068.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 각 유저별 dcg, idcg, ndcg 계산하는 기능</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_ndcg</span>(<span class="params">rec_df</span>):</span><br><span class="line">  <span class="comment"># rec_df: 유저당 추천된 &#x27;라벨&#x27;과 &#x27;라벨에 해당하는 상품 아이디&#x27;, &#x27;T/F(true_like여부)&#x27;특성이 포함된 데이터프레임 (dataframe about recommended &#x27;label&#x27; and &#x27;product_id&#x27;, &#x27;T/F(true_like or not)&#x27; for each user)</span></span><br><span class="line">  rec = rec_df[<span class="string">&#x27;rec_id&#x27;</span>].tolist()</span><br><span class="line">  t = rec_df[<span class="string">&#x27;T/F&#x27;</span>].tolist()</span><br><span class="line">  dcg = <span class="number">0.0</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">#dcg 계산</span></span><br><span class="line">  <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">enumerate</span>(t): <span class="comment"># i, j: T/F안의 인덱스와 값들(1.0, 0.0..)을 돈다.</span></span><br><span class="line">    <span class="keyword">if</span> j == <span class="number">1.0</span>:</span><br><span class="line">      dcg += (<span class="number">1.0</span>/np.log2(i+<span class="number">1</span>+<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">      dcg += <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">#idcg 계산</span></span><br><span class="line">  idcg = <span class="built_in">sum</span>((<span class="number">1.0</span>/np.log2(i+<span class="number">1</span>+<span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(t)+<span class="number">1</span>)))</span><br><span class="line"></span><br><span class="line">  <span class="comment">#ndcg 계산</span></span><br><span class="line">  ndcg = dcg / idcg </span><br><span class="line">  </span><br><span class="line">  <span class="comment"># set 으로 결과 산출할 경우,</span></span><br><span class="line">  <span class="comment"># return dcg, idcg, ndcg</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">#dataframe으로 결과 산출할 경우,</span></span><br><span class="line">  ndcg_df = pd.DataFrame(columns=[<span class="string">&#x27;dcg&#x27;</span>, <span class="string">&#x27;idcg&#x27;</span>, <span class="string">&#x27;ndcg&#x27;</span>])</span><br><span class="line">  ndcg_df = ndcg_df.append(pd.DataFrame([[dcg, idcg, ndcg]], columns=[<span class="string">&#x27;dcg&#x27;</span>, <span class="string">&#x27;idcg&#x27;</span>, <span class="string">&#x27;ndcg&#x27;</span>]), ignore_index=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ndcg_df</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- user1의 dcg, idcg, ndcg </span></span><br><span class="line">ndcg_df1 = get_ndcg(rec_df1)</span><br><span class="line"><span class="built_in">print</span>(ndcg_df1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- user2의 dcg, idcg, ndcg </span></span><br><span class="line">ndcg_df2 = get_ndcg(rec_df2)</span><br><span class="line"><span class="built_in">print</span>(ndcg_df2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- user3의 dcg, idcg, ndcg </span></span><br><span class="line">ndcg_df3 = get_ndcg(rec_df3)</span><br><span class="line"><span class="built_in">print</span>(ndcg_df3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- user4의 dcg, idcg, ndcg </span></span><br><span class="line">ndcg_df4 = get_ndcg(rec_df4)</span><br><span class="line"><span class="built_in">print</span>(ndcg_df4)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- user5의 dcg, idcg, ndcg </span></span><br><span class="line">ndcg_df5 = get_ndcg(rec_df5)</span><br><span class="line"><span class="built_in">print</span>(ndcg_df5)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2069.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># user별 dcg, idcg, ndcg 결과를 합쳐주는 함수 기능. </span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">concat_result</span>(<span class="params">df1, df2</span>):</span><br><span class="line">  df3 = pd.concat([df1, df2])</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> df3</span><br><span class="line"></span><br><span class="line">result = concat_result(ndcg_df1, ndcg_df2)</span><br><span class="line">result = concat_result(result, ndcg_df3)</span><br><span class="line">result = concat_result(result, ndcg_df4)</span><br><span class="line">result = concat_result(result, ndcg_df5)</span><br><span class="line">result.index=[<span class="string">&#x27;test-user1&#x27;</span>, <span class="string">&#x27;test-user2&#x27;</span>, <span class="string">&#x27;test-user3&#x27;</span>, <span class="string">&#x27;test-user4&#x27;</span>, <span class="string">&#x27;test-user5&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[ ranking_1안의 유저별 dcg, idcg, ndcg ] \n &#x27;</span>, result)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;-------------------\n&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[ ranking_1안의 dcg, idcg, ndcg평균 ] \n&#x27;</span>, result.mean())</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2070.png" alt=" "></p>
<h3 id="rank-2안-order-number-기준-like-x2F-dislike-에-따른-순위-목록-의-nDCG"><a href="#rank-2안-order-number-기준-like-x2F-dislike-에-따른-순위-목록-의-nDCG" class="headerlink" title="rank_2안(order_number 기준 like&#x2F;dislike 에 따른 순위 목록)의 nDCG"></a>rank_2안(order_number 기준 like&#x2F;dislike 에 따른 순위 목록)의 nDCG</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1안의 유저별 추천 &#x27;상품묶음&#x27; 라벨들. </span></span><br><span class="line">ranking_2</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2071.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pd_name_d</span></span><br><span class="line"><span class="comment"># train_data_r[[&#x27;predict_labels&#x27;,&#x27;pd_name_d&#x27;]]</span></span><br><span class="line">train_df2 = train_data_r_2[[<span class="string">&#x27;like&#x27;</span>, <span class="string">&#x27;predict_labels&#x27;</span>]].rename(columns=&#123;<span class="string">&#x27;like&#x27;</span>: <span class="string">&#x27;like_id&#x27;</span>, <span class="string">&#x27;predict_labels&#x27;</span>:<span class="string">&#x27;label&#x27;</span>&#125;)</span><br><span class="line">train_df2</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2072.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># predict_labels: 유저별 라벨 역할. </span></span><br><span class="line"><span class="comment"># pd_name_d : user A가 구매한 상품명 인덱스 수치 묶음.</span></span><br><span class="line"><span class="comment"># 비슷한 유저의 상품 목록을 추천하는 것으로 생각. </span></span><br><span class="line"></span><br><span class="line">true_df2 = test_data_r_2[[<span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;like&#x27;</span>]].rename(columns=&#123;<span class="string">&#x27;like&#x27;</span>: <span class="string">&#x27;true_like_id&#x27;</span>&#125;)</span><br><span class="line">true_df2</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2073.png" alt=" "></p>
<h3 id="rank-2안-최종-ndcg-값"><a href="#rank-2안-최종-ndcg-값" class="headerlink" title="rank_2안 최종 ndcg 값"></a>rank_2안 최종 ndcg 값</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># user 당 추천목록 데이터 추출하는 기능</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_rec</span>(<span class="params">n , rank, rec_df, train_df</span>):</span><br><span class="line">  <span class="comment"># 전달인자(argument) 설명 :</span></span><br><span class="line">   <span class="comment">## n: 몇번째 유저인지(the order of test-user starting from 0) </span></span><br><span class="line">   <span class="comment">## rank: 랭킹 결과 (ranking result of ranking model (array type))</span></span><br><span class="line">   <span class="comment">## rec_df: 유저당 추천된 라벨과 라벨에 해당하는 상품 아이디 데이터프레임 (recommended label and product_id for each user)</span></span><br><span class="line">   <span class="comment">## train_df: 랭킹 모델학습에 사용된 학습데이터에서 필요한 like, predict_labels만 추출한 데이터프레임(train_data&#x27;s &#x27;like and predict_labels&#x27;features used for ranking_model training)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> label <span class="keyword">in</span> rank[n-<span class="number">1</span>]: <span class="comment"># user2번째(array index=1) DF 만들기.</span></span><br><span class="line">    rec_id = train_df[<span class="string">&#x27;like_id&#x27;</span>][(train_df[<span class="string">&#x27;label&#x27;</span>]==label)].tolist()</span><br><span class="line">    rec_df = rec_df.append(pd.DataFrame([[label, rec_id]], columns=[<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;rec_id&#x27;</span>]), ignore_index=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># rec_id = train_data[&#x27;product_id&#x27;][(train_data[&#x27;label&#x27;]==label)].values</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> rec_df</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user1</span></span><br><span class="line"><span class="comment"># user1_rec_data = pd.DataFrame(columns=[&#x27;label&#x27;, &#x27;rec_id&#x27;, &#x27;T/F&#x27;])</span></span><br><span class="line">user1_rec_data = pd.DataFrame(columns=[<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;rec_id&#x27;</span>])</span><br><span class="line"></span><br><span class="line">rec_df1 = user_rec(<span class="number">1</span>, ranking_2, user1_rec_data, train_df2)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;user1_rec_data&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(rec_df1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user2</span></span><br><span class="line"><span class="comment"># user2_rec_data = pd.DataFrame(columns=[&#x27;label&#x27;, &#x27;rec_id&#x27;, &#x27;T/F&#x27;])</span></span><br><span class="line">user2_rec_data = pd.DataFrame(columns=[<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;rec_id&#x27;</span>])</span><br><span class="line"></span><br><span class="line">rec_df2 = user_rec(<span class="number">2</span>, ranking_2, user2_rec_data, train_df2)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;user2_rec_data&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(rec_df2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user3</span></span><br><span class="line">user3_rec_data = pd.DataFrame(columns=[<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;rec_id&#x27;</span>])</span><br><span class="line"></span><br><span class="line">rec_df3 = user_rec(<span class="number">3</span>, ranking_2, user3_rec_data, train_df2)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;user3_rec_data&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(rec_df3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user4</span></span><br><span class="line">user4_rec_data = pd.DataFrame(columns=[<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;rec_id&#x27;</span>])</span><br><span class="line"></span><br><span class="line">rec_df4 = user_rec(<span class="number">4</span>, ranking_2, user4_rec_data, train_df2)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;user4_rec_data&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(rec_df4)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user5</span></span><br><span class="line">user5_rec_data = pd.DataFrame(columns=[<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;rec_id&#x27;</span>])</span><br><span class="line"></span><br><span class="line">rec_df5 = user_rec(<span class="number">5</span>, ranking_2, user5_rec_data, train_df2)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;user5_rec_data&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(rec_df5)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2074.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 각 유저별 추천목록의 상품들 중 true-like한 것이 있는지 T/F(trud:1/false:0)으로 데이터프레임에 넣어주는 기능.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">true_like</span>(<span class="params">n, rec_df, true_df</span>):</span><br><span class="line">  <span class="comment"># 전달인자(argument)설명: </span></span><br><span class="line">   <span class="comment">## n: 몇번째 유저인지 (the order of test-user starting from 0)</span></span><br><span class="line">   <span class="comment">## rec_df: 유저당 추천된 라벨과 라벨에 해당하는 상품 아이디 데이터프레임 (recommended label and product_id for each user)</span></span><br><span class="line">   <span class="comment">## true_df: 랭킹모델의 예측에 사용된 test_data중에서 필요한 &#x27;user_id, true_like_id&#x27;특성만 추출한 데이터프레임(test_data&#x27;s &#x27;user_id and true_like_id&#x27;features used for ranking_model predicting)</span></span><br><span class="line">  tf_list = []</span><br><span class="line">  rec_id = rec_df[<span class="string">&#x27;rec_id&#x27;</span>].tolist() </span><br><span class="line">  <span class="comment"># rec_id = rec_df[&#x27;rec_id&#x27;].values </span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># true데이터인 test_data의 형태상, row에 있는 유저 n-1번째 row를 고정해야 함. </span></span><br><span class="line">  true = true_df[<span class="string">&#x27;true_like_id&#x27;</span>].tolist()[n-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> rec <span class="keyword">in</span> rec_id[:][:]:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(rec) == <span class="number">0</span>:</span><br><span class="line">      tf_list.append(<span class="number">0.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">len</span>(rec)&gt;=<span class="number">1</span>:        </span><br><span class="line">      tf = true[<span class="number">0</span>] <span class="keyword">in</span> rec[<span class="number">0</span>]</span><br><span class="line">      <span class="keyword">if</span> tf == <span class="literal">True</span>:</span><br><span class="line">        tf_list.append(<span class="number">1</span>)</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        tf_list.append(<span class="number">0</span>)</span><br><span class="line">      rec_df[<span class="string">&#x27;T/F&#x27;</span>] = pd.DataFrame(tf_list)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;true_like_id:&quot;</span>, true)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rec_df</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user1의 추천목록에 대한 T/F(true-like or false) 결과 </span></span><br><span class="line">rec_df1 = true_like(<span class="number">1</span>, rec_df1, true_df2)</span><br><span class="line"><span class="built_in">print</span>(rec_df1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user2의 추천목록에 대한 T/F(true-like or false) 결과 </span></span><br><span class="line">rec_df2 = true_like(<span class="number">2</span>, rec_df2, true_df2)</span><br><span class="line"><span class="built_in">print</span>(rec_df2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user3의 추천목록에 대한 T/F(true-like or false) 결과 </span></span><br><span class="line">rec_df3 = true_like(<span class="number">3</span>, rec_df3, true_df2)</span><br><span class="line"><span class="built_in">print</span>(rec_df3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user4의 추천목록에 대한 T/F(true-like or false) 결과 </span></span><br><span class="line">rec_df4 = true_like(<span class="number">4</span>, rec_df4, true_df2)</span><br><span class="line"><span class="built_in">print</span>(rec_df4)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---user5의 추천목록에 대한 T/F(true-like or false) 결과 </span></span><br><span class="line">rec_df5 = true_like(<span class="number">5</span>, rec_df5, true_df2)</span><br><span class="line"><span class="built_in">print</span>(rec_df5)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2075.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 각 유저별 dcg, idcg, ndcg 계산하는 기능</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_ndcg</span>(<span class="params">rec_df</span>):</span><br><span class="line">  <span class="comment"># rec_df: 유저당 추천된 &#x27;라벨&#x27;과 &#x27;라벨에 해당하는 상품 아이디&#x27;, &#x27;T/F(true_like여부)&#x27;특성이 포함된 데이터프레임 (dataframe about recommended &#x27;label&#x27; and &#x27;product_id&#x27;, &#x27;T/F(true_like or not)&#x27; for each user)</span></span><br><span class="line">  rec = rec_df[<span class="string">&#x27;rec_id&#x27;</span>].tolist()</span><br><span class="line">  t = rec_df[<span class="string">&#x27;T/F&#x27;</span>].tolist()</span><br><span class="line">  dcg = <span class="number">0.0</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">#dcg 계산</span></span><br><span class="line">  <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">enumerate</span>(t): <span class="comment"># i, j: T/F안의 인덱스와 값들(1.0, 0.0..)을 돈다.</span></span><br><span class="line">    <span class="keyword">if</span> j == <span class="number">1.0</span>:</span><br><span class="line">      dcg += (<span class="number">1.0</span>/np.log2(i+<span class="number">1</span>+<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">      dcg += <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">#idcg 계산</span></span><br><span class="line">  idcg = <span class="built_in">sum</span>((<span class="number">1.0</span>/np.log2(i+<span class="number">1</span>+<span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(t)+<span class="number">1</span>)))</span><br><span class="line"></span><br><span class="line">  <span class="comment">#ndcg 계산</span></span><br><span class="line">  ndcg = dcg / idcg </span><br><span class="line">  </span><br><span class="line">  <span class="comment"># set 으로 결과 산출할 경우,</span></span><br><span class="line">  <span class="comment"># return dcg, idcg, ndcg</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">#dataframe으로 결과 산출할 경우,</span></span><br><span class="line">  ndcg_df = pd.DataFrame(columns=[<span class="string">&#x27;dcg&#x27;</span>, <span class="string">&#x27;idcg&#x27;</span>, <span class="string">&#x27;ndcg&#x27;</span>])</span><br><span class="line">  ndcg_df = ndcg_df.append(pd.DataFrame([[dcg, idcg, ndcg]], columns=[<span class="string">&#x27;dcg&#x27;</span>, <span class="string">&#x27;idcg&#x27;</span>, <span class="string">&#x27;ndcg&#x27;</span>]), ignore_index=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ndcg_df</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- user1의 dcg, idcg, ndcg </span></span><br><span class="line">ndcg_df1 = get_ndcg(rec_df1)</span><br><span class="line"><span class="built_in">print</span>(ndcg_df1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- user2의 dcg, idcg, ndcg </span></span><br><span class="line">ndcg_df2 = get_ndcg(rec_df2)</span><br><span class="line"><span class="built_in">print</span>(ndcg_df2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- user3의 dcg, idcg, ndcg </span></span><br><span class="line">ndcg_df3 = get_ndcg(rec_df3)</span><br><span class="line"><span class="built_in">print</span>(ndcg_df3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- user4의 dcg, idcg, ndcg </span></span><br><span class="line">ndcg_df4 = get_ndcg(rec_df4)</span><br><span class="line"><span class="built_in">print</span>(ndcg_df4)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- user5의 dcg, idcg, ndcg </span></span><br><span class="line">ndcg_df5 = get_ndcg(rec_df5)</span><br><span class="line"><span class="built_in">print</span>(ndcg_df5)</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2076.png" alt=" "></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># user별 dcg, idcg, ndcg 결과를 합쳐주는 함수 기능. </span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">concat_result</span>(<span class="params">df1, df2</span>):</span><br><span class="line">  df3 = pd.concat([df1, df2])</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> df3</span><br><span class="line"></span><br><span class="line">result = concat_result(ndcg_df1, ndcg_df2)</span><br><span class="line">result = concat_result(result, ndcg_df3)</span><br><span class="line">result = concat_result(result, ndcg_df4)</span><br><span class="line">result = concat_result(result, ndcg_df5)</span><br><span class="line">result.index=[<span class="string">&#x27;test-user1&#x27;</span>, <span class="string">&#x27;test-user2&#x27;</span>, <span class="string">&#x27;test-user3&#x27;</span>, <span class="string">&#x27;test-user4&#x27;</span>, <span class="string">&#x27;test-user5&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[ ranking_2안의 유저별 dcg, idcg, ndcg ] \n &#x27;</span>, result)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;-------------------\n&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[ ranking_2안의 dcg, idcg, ndcg평균 ] \n&#x27;</span>, result.mean())</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ecommerce_Rec/Untitled%2077.png" alt=" "></p>
<h1 id="결론-및-향후-보완할-사항"><a href="#결론-및-향후-보완할-사항" class="headerlink" title="결론 및 향후 보완할 사항"></a>결론 및 향후 보완할 사항</h1><p>(1) ranking_2안의 전체 평균 결과는 nDCG 스코어에서 0.1 높음.</p>
<ul>
<li>ranking_1안 ndcg 평균: 0.28</li>
<li>ranking_2안 ndcg 평균: 0.38</li>
</ul>
<p>(2) 유저별로 nDCG스코어가 ranking_1안이 높은 경우가 있고, ranking_2안이 높은 경우가 있으므로, 개인별 맞춤 제안을 하면 좋을 것, 특히 0이 나오는 경우도 있어서 이 경우는 신경 써서 제안을 해야 함.</p>
<ul>
<li>user2: 0.37 (ranking1_ndcg) &lt; 0.57 (ranking2_ndcg)</li>
<li>user1: 0.52 (ranking1_ndcg) &lt; 0.00 (ranking2_ndcg)</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[ ranking_1안의 유저별 dcg, idcg, ndcg ]</span><br><span class="line">                   dcg      idcg      ndcg</span><br><span class="line">test-user1  2.061606  3.953465  0.521468</span><br><span class="line">test-user2  1.487137  3.953465  0.376160</span><br><span class="line">test-user3  1.487137  3.953465  0.376160</span><br><span class="line">test-user4  0.500000  3.953465  0.126471</span><br><span class="line">test-user5  0.000000  3.953465  0.000000</span><br><span class="line">-------------------</span><br><span class="line"></span><br><span class="line">[ ranking_1안의 dcg, idcg, ndcg평균 ]</span><br><span class="line"> dcg     1.107176</span><br><span class="line">idcg    3.953465</span><br><span class="line">ndcg    0.280052</span><br><span class="line"></span><br><span class="line">[ ranking_2안의 유저별 dcg, idcg, ndcg ]</span><br><span class="line">                   dcg      idcg      ndcg</span><br><span class="line">test-user1  0.000000  3.953465  0.000000</span><br><span class="line">test-user2  2.264010  3.953465  0.572665</span><br><span class="line">test-user3  1.500000  3.953465  0.379414</span><br><span class="line">test-user4  1.500000  3.953465  0.379414</span><br><span class="line">test-user5  2.351116  3.953465  0.594698</span><br><span class="line">-------------------</span><br><span class="line"></span><br><span class="line">[ ranking_2안의 dcg, idcg, ndcg평균 ]</span><br><span class="line"> dcg     1.523025</span><br><span class="line">idcg    3.953465</span><br><span class="line">ndcg    0.385238</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>(3) ranking 1,2 안의 차이점:</p>
<ul>
<li>(ranking_1안) reorder(재주문 여부)로 rating을 매긴 개념으로, 재주문을 한 경우(1)라면 <strong>like</strong>, 재주문을 안 한 경우(0)라면 <strong>dislike</strong>로 상품을 구분한 feature를 랭킹모델에 추가하여 추천목록을 생성한 방법.</li>
<li>(ranking_2안) order_number(주문회차: 몇번째 구매인지)로 rating을 매긴 개념으로, 평균 주문회차인 18 이상인 경우(1) <strong>like</strong>, 18 미만(0)이면 <strong>dislike</strong>로 상품을 구분한 feature를 랭킹모델에 추가하여 추천목록을 생성한 방법.</li>
</ul>
<hr>
<ul>
<li>Reference<ul>
<li><a target="_blank" rel="noopener" href="https://jalynne-kim.medium.com/%EC%B6%94%EC%B2%9C%EB%AA%A8%EB%8D%B8-%EC%9D%B4%EC%BB%A4%EB%A8%B8%EC%8A%A4-%EC%B6%94%EC%B2%9C%EB%AA%A8%EB%8D%B8%EB%A7%81-%EB%94%A5%EB%9F%AC%EB%8B%9D%EB%AA%A8%EB%8D%B8-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%ED%9A%8C%EA%B3%A0-d5017cb1335f">https://jalynne-kim.medium.com/추천모델-이커머스-추천모델링-딥러닝모델-프로젝트-회고-d5017cb1335f</a></li>
</ul>
</li>
</ul>

        </div>
        <footer class="article-footer">
            



    <a data-url="https://jmj3047.github.io/2023/04/03/Ecommerce_Rec/" data-id="clgw0znb9001b4du660xlg3ye" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "author": {
            "@type": "Person",
            "name": "Jang Minjee"
        },
        "headline": "Ecommerce Recommendation System",
        "image": "https://jmj3047.github.io/images/Ecommerce_Rec/structure.png",
        "keywords": "Recommendation System Deep Nueral Networks Vertex AI",
        "genre": "Data Platform/Base GCP",
        "datePublished": "2023-04-03",
        "dateCreated": "2023-04-03",
        "dateModified": "2023-04-06",
        "url": "https://jmj3047.github.io/2023/04/03/Ecommerce_Rec/",
        "description": "개요
kaggle instacart 데이터로 추천 모델링 시스템을 만들기
빅쿼리, Vertex AI를 사용하여 모델을 만들고 예측하기
참고한 유투브의 추천시스템은 평점 feature가 있지만 이 데이터에는 존재 하지 않음. 따라서 재주문 여부와 주문회차를 평점으로 가정하고 모델에 도입함
200만 유저 중에 10000명으로 제한하였고, 모델 평가에 대한 지표",
        "wordCount": 10748
    }
</script>

</article>

    <section id="comments">
    
    </section>



                        </div>
                    </section>
                    
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>follow:</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/jmj3047" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="dropbox" href="https://www.dropbox.com/home" target="_blank" rel="noopener">
                        <i class="icon fa fa-dropbox"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google" href="https://www.google.com" target="_blank" rel="noopener">
                        <i class="icon fa fa-google"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="youtube" href="https://www.youtube.com/" target="_blank" rel="noopener">
                        <i class="icon fa fa-youtube"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="discord" href="https://discord.com/channels/@me" target="_blank" rel="noopener">
                        <i class="icon fa fa-discord"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
<!-- 
    <div class="github-card" data-github="jmj3047" data-width="400" data-height="" data-theme="default">
    </div>
    <script src="//cdn.jsdelivr.net/github-cards/latest/widget.js">    </script> -->

    
        
<nav id="article-nav">
    
        <a href="/2023/04/04/ML_Part3/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">newer</strong>
        <p class="article-nav-title">
        
            Unsupervised Learning, Recommenders, Reinforcement Learning
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2023/03/31/DNN_Youtube_Rec/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">older</strong>
        <p class="article-nav-title">Deep Nueral Networks for YouTube Recommendations</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    


    <div class="widgets-container">
        
        
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">recents</h3>
        <div class="widget">
            <ul id="recent-post" class="no-thumbnail">
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Paper/">Paper</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/Paper/Speech-Emotion-Recognition/">Speech Emotion Recognition</a></p>
                            <p class="item-title"><a href="/2023/07/17/Speaker_Normalization_for_SER/" class="title">Speaker Normalization for Self-Supervised Speech Emotion Recognition</a></p>
                            <p class="item-date"><time datetime="2023-07-16T15:00:00.000Z" itemprop="datePublished">2023-07-17</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Paper/">Paper</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/Paper/Speech-Emotion-Recognition/">Speech Emotion Recognition</a></p>
                            <p class="item-title"><a href="/2023/07/15/SER_for_self_supervised/" class="title">Speech Emotion Recognition Using Self-Supervised Features</a></p>
                            <p class="item-date"><time datetime="2023-07-14T15:00:00.000Z" itemprop="datePublished">2023-07-15</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Data-Analysis/">Data Analysis</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/Data-Analysis/Model/">Model</a></p>
                            <p class="item-title"><a href="/2023/07/11/MLOps_Part2/" class="title">Machine Learning Data Lifecycle in Production</a></p>
                            <p class="item-date"><time datetime="2023-07-10T15:00:00.000Z" itemprop="datePublished">2023-07-11</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Data-Analysis/">Data Analysis</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/Data-Analysis/Basic/">Basic</a></p>
                            <p class="item-title"><a href="/2023/07/11/MLOps2_Quiz/" class="title">Machine Learning Data Lifecycle in Production_Quiz</a></p>
                            <p class="item-date"><time datetime="2023-07-10T15:00:00.000Z" itemprop="datePublished">2023-07-11</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Paper/">Paper</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/Paper/Speech-Emotion-Recognition/">Speech Emotion Recognition</a></p>
                            <p class="item-title"><a href="/2023/07/03/DIFL_SI_SER/" class="title">Domain Invariant Feature Learning for Speaker-Independent Speech Emotion Recognition</a></p>
                            <p class="item-date"><time datetime="2023-07-02T15:00:00.000Z" itemprop="datePublished">2023-07-03</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">categories</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Analysis/">Data Analysis</a><span class="category-list-count">38</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Analysis/Basic/">Basic</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Analysis/Model/">Model</a><span class="category-list-count">16</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Platform-Base/">Data Platform/Base</a><span class="category-list-count">16</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Platform-Base/GCP/">GCP</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Platform-Base/MongoDB/">MongoDB</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Paper/">Paper</a><span class="category-list-count">21</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Paper/Computer-Vision/">Computer Vision</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Paper/Generative-Model/">Generative Model</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Paper/Multi-Task-Learning/">Multi-Task Learning</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Paper/NLP/">NLP</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Paper/Recommendation-System/">Recommendation System</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Paper/Speaker-Verification/">Speaker Verification</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Paper/Speech-Emotion-Recognition/">Speech Emotion Recognition</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Paper/Speech-Representations/">Speech Representations</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Django/">Django</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/HTML/">HTML</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Pyspark/">Pyspark</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python/">Python</a><span class="category-list-count">5</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Setting/">Setting</a><span class="category-list-count">5</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/ACF/" style="font-size: 10px;">ACF</a> <a href="/tags/AI-Studies/" style="font-size: 16.92px;">AI Studies</a> <a href="/tags/AI-tool/" style="font-size: 10px;">AI tool</a> <a href="/tags/ARIMA/" style="font-size: 10px;">ARIMA</a> <a href="/tags/Acoustic-Parameter-Set/" style="font-size: 10px;">Acoustic Parameter Set</a> <a href="/tags/Adversarial-Domain-Adaptation/" style="font-size: 10px;">Adversarial Domain Adaptation</a> <a href="/tags/Adversarial-Speaker-Verification/" style="font-size: 10px;">Adversarial Speaker Verification</a> <a href="/tags/Attention/" style="font-size: 10.77px;">Attention</a> <a href="/tags/Auth/" style="font-size: 10px;">Auth</a> <a href="/tags/Automation/" style="font-size: 10px;">Automation</a> <a href="/tags/Bash/" style="font-size: 10px;">Bash</a> <a href="/tags/BeautifulSoup/" style="font-size: 11.54px;">BeautifulSoup</a> <a href="/tags/Big-Query/" style="font-size: 16.15px;">Big Query</a> <a href="/tags/BigQueryML/" style="font-size: 13.85px;">BigQueryML</a> <a href="/tags/Brython/" style="font-size: 10px;">Brython</a> <a href="/tags/CGI/" style="font-size: 10px;">CGI</a> <a href="/tags/Center-Loss/" style="font-size: 10px;">Center Loss</a> <a href="/tags/Chatbot/" style="font-size: 13.08px;">Chatbot</a> <a href="/tags/Clustering/" style="font-size: 13.85px;">Clustering</a> <a href="/tags/Confusion-Matrix/" style="font-size: 10px;">Confusion Matrix</a> <a href="/tags/Convolutional-Neural-Networks/" style="font-size: 10.77px;">Convolutional Neural Networks</a> <a href="/tags/Coursera/" style="font-size: 18.46px;">Coursera</a> <a href="/tags/Cross-domain/" style="font-size: 10px;">Cross-domain</a> <a href="/tags/DBSCAN/" style="font-size: 10px;">DBSCAN</a> <a href="/tags/DCGAN/" style="font-size: 10px;">DCGAN</a> <a href="/tags/DataFlow/" style="font-size: 10px;">DataFlow</a> <a href="/tags/Decision-Tree-Classifier/" style="font-size: 10px;">Decision Tree Classifier</a> <a href="/tags/Deep-Nueral-Networks/" style="font-size: 10.77px;">Deep Nueral Networks</a> <a href="/tags/Deep-Machine-Learning-Paper-Study/" style="font-size: 17.69px;">Deep/Machine Learning Paper Study</a> <a href="/tags/Doc2vec/" style="font-size: 12.31px;">Doc2vec</a> <a href="/tags/Domain-Adaptation/" style="font-size: 10px;">Domain Adaptation</a> <a href="/tags/Domain-Adversarial-Layer/" style="font-size: 10px;">Domain Adversarial Layer</a> <a href="/tags/Domain-Invariant-Feature-Learning/" style="font-size: 10.77px;">Domain Invariant Feature Learning</a> <a href="/tags/English/" style="font-size: 19.23px;">English</a> <a href="/tags/Ensemble-Model/" style="font-size: 10px;">Ensemble Model</a> <a href="/tags/Error/" style="font-size: 10px;">Error</a> <a href="/tags/F1-measure/" style="font-size: 10px;">F1 measure</a> <a href="/tags/Flask/" style="font-size: 10px;">Flask</a> <a href="/tags/GAN/" style="font-size: 10.77px;">GAN</a> <a href="/tags/GCP/" style="font-size: 10px;">GCP</a> <a href="/tags/Gaussian-Mixture-Model/" style="font-size: 10.77px;">Gaussian Mixture Model</a> <a href="/tags/Gen-App-Builder/" style="font-size: 10px;">Gen App Builder</a> <a href="/tags/Generative-Adversarial-Network/" style="font-size: 10px;">Generative Adversarial Network</a> <a href="/tags/Generative-Model/" style="font-size: 10px;">Generative Model</a> <a href="/tags/Git/" style="font-size: 10.77px;">Git</a> <a href="/tags/Grid-Search-CV/" style="font-size: 10px;">Grid Search CV</a> <a href="/tags/HTML/" style="font-size: 11.54px;">HTML</a> <a href="/tags/Hexo/" style="font-size: 12.31px;">Hexo</a> <a href="/tags/Hueman/" style="font-size: 10px;">Hueman</a> <a href="/tags/Image-Classification/" style="font-size: 11.54px;">Image Classification</a> <a href="/tags/K-Means-Clustering/" style="font-size: 11.54px;">K-Means Clustering</a> <a href="/tags/Kaggle/" style="font-size: 10px;">Kaggle</a> <a href="/tags/Looker-Studio/" style="font-size: 11.54px;">Looker Studio</a> <a href="/tags/ML-Analysis/" style="font-size: 20px;">ML Analysis</a> <a href="/tags/ML-Operations/" style="font-size: 10.77px;">ML Operations</a> <a href="/tags/ML-Process/" style="font-size: 10.77px;">ML Process</a> <a href="/tags/MongoDB/" style="font-size: 11.54px;">MongoDB</a> <a href="/tags/Multi-Task-Learning/" style="font-size: 10.77px;">Multi-Task Learning</a> <a href="/tags/NLP/" style="font-size: 13.08px;">NLP</a> <a href="/tags/Nonprobability-sampling/" style="font-size: 10px;">Nonprobability sampling</a> <a href="/tags/Normal-Distribution/" style="font-size: 10px;">Normal Distribution</a> <a href="/tags/PACF/" style="font-size: 10px;">PACF</a> <a href="/tags/Pandas-Dataframe/" style="font-size: 10px;">Pandas Dataframe</a> <a href="/tags/Precision-Recall/" style="font-size: 10px;">Precision-Recall</a> <a href="/tags/Probabilistic-sampling/" style="font-size: 10px;">Probabilistic sampling</a> <a href="/tags/Probability-Density-Function/" style="font-size: 10px;">Probability Density Function</a> <a href="/tags/Probability-Distribution-Function/" style="font-size: 10px;">Probability Distribution Function</a> <a href="/tags/Python/" style="font-size: 16.92px;">Python</a> <a href="/tags/Quiz/" style="font-size: 14.62px;">Quiz</a> <a href="/tags/ROC-curve/" style="font-size: 10px;">ROC curve</a> <a href="/tags/Recommendation-System/" style="font-size: 10.77px;">Recommendation System</a> <a href="/tags/Self-Supervised-Features/" style="font-size: 10px;">Self-Supervised Features</a> <a href="/tags/Self-Supervised-Learning/" style="font-size: 10.77px;">Self-Supervised Learning</a> <a href="/tags/Speaker-GAN/" style="font-size: 10px;">Speaker GAN</a> <a href="/tags/Speaker-Identification/" style="font-size: 10px;">Speaker Identification</a> <a href="/tags/Speaker-Independent/" style="font-size: 10px;">Speaker Independent</a> <a href="/tags/Speaker-Normalization/" style="font-size: 10px;">Speaker Normalization</a> <a href="/tags/Speaker-Verification/" style="font-size: 10px;">Speaker Verification</a> <a href="/tags/Speech-Emotion-Recognition/" style="font-size: 15.38px;">Speech Emotion Recognition</a> <a href="/tags/Speech-Feature-Extraction/" style="font-size: 10px;">Speech Feature Extraction</a> <a href="/tags/Speech-Representations/" style="font-size: 10px;">Speech Representations</a> <a href="/tags/Standard-Normal-Distribution/" style="font-size: 10px;">Standard Normal Distribution</a> <a href="/tags/TD-SV/" style="font-size: 10px;">TD-SV</a> <a href="/tags/Threshold-Adjustment/" style="font-size: 10px;">Threshold Adjustment</a> <a href="/tags/Time-Series/" style="font-size: 10px;">Time Series</a> <a href="/tags/Transfer-Learning/" style="font-size: 10px;">Transfer Learning</a> <a href="/tags/Transformer/" style="font-size: 11.54px;">Transformer</a> <a href="/tags/Vertex-AI/" style="font-size: 10px;">Vertex AI</a> <a href="/tags/Virtualenv/" style="font-size: 10px;">Virtualenv</a> <a href="/tags/Voice-Trigger-Detection/" style="font-size: 10.77px;">Voice Trigger Detection</a> <a href="/tags/WGAN/" style="font-size: 10px;">WGAN</a> <a href="/tags/WGAN-GP/" style="font-size: 10px;">WGAN-GP</a> <a href="/tags/Wake-Up-Words/" style="font-size: 10px;">Wake-Up Words</a> <a href="/tags/Web-Crawling/" style="font-size: 11.54px;">Web Crawling</a> <a href="/tags/Web-Server/" style="font-size: 10.77px;">Web Server</a> <a href="/tags/kaggle/" style="font-size: 10px;">kaggle</a> <a href="/tags/pyspark/" style="font-size: 12.31px;">pyspark</a>
        </div>
    </div>


            
        

    </div>
</aside>


                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2023 Jang Minjee</p>
                
                <p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="https://github.com/ppoffice" target="_blank">PPOffice</a></p>
                
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

    </div>
    


    
        
<script src="/libs/lightgallery/js/lightgallery.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-pager.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-zoom.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-hash.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-share.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-video.min.js"></script>

    
    
        
<script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>

    
    
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
        </script>
        
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML.js"></script>

    

    
      <script data-ad-client="ca-pub-2182912223281192" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

    
    
    



<!-- Custom Scripts -->

<script src="/js/main.js"></script>


</body>
</html>
